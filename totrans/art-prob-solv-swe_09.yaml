- en: The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better
- en: 原文：[https://enhancedformysql.github.io/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Chapter6.html](https://enhancedformysql.github.io/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Chapter6.html)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 原文：[https://enhancedformysql.github.io/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Chapter6.html](https://enhancedformysql.github.io/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Chapter6.html)
- en: 'Chapter 6: How to Scientifically Test MySQL Performance?'
  id: totrans-2
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第六章：如何科学地测试 MySQL 性能？
- en: Performance benchmarking is commonly used to compare different systems or algorithms
    in both scientific literature and industrial publications. Although performance
    measurements might seem objective, various factors can influence benchmark results,
    intentionally or accidentally, favoring one system over another. There is a fundamental
    conflict of interest in performance benchmarking, especially when evaluations
    are made against previous versions or competitors’ systems. Some results, often
    referred to as “benchmarketing”, misrepresent performance data. Fair performance
    benchmarking is challenging, and it’s easy to misrepresent data, either by accident
    or on purpose [9].
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 性能基准测试在科学文献和工业出版物中常用于比较不同的系统或算法。尽管性能测量可能看似客观，但各种因素可能会影响基准测试结果，有意或无意地偏向某一系统。性能基准测试存在根本的利益冲突，尤其是在对先前版本或竞争对手的系统进行评估时。一些结果，通常被称为“基准营销”，歪曲了性能数据。公平的性能基准测试具有挑战性，很容易无意或有意地歪曲数据[9]。
- en: This book explores common pitfalls in MySQL performance benchmarking and describes
    how to avoid them to ensure fair performance comparisons.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本书探讨了 MySQL 性能基准测试中的常见陷阱，并描述了如何避免它们以确保公平的性能比较。
- en: 6.1 Common Pitfalls
  id: totrans-5
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.1 常见陷阱
- en: This section discusses common pitfalls encountered when performing performance
    comparisons.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 本节讨论在执行性能比较时遇到的常见陷阱。
- en: 6.1.1 Non-Reproducibility
  id: totrans-7
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.1.1 不可重复性
- en: Reproducibility is a cornerstone of scientific research, allowing others to
    verify results and identify errors. Without reproducibility, claims and numbers
    in experiments cannot be validated. Conducting reproducible experiments is relatively
    straightforward and cost-effective compared to larger scientific studies. However,
    many database research papers lack reproducibility due to closed-source code,
    undisclosed data, or proprietary systems.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 可重复性是科学研究的基础，它允许他人验证结果并识别错误。没有可重复性，实验中的主张和数字无法得到验证。进行可重复的实验相对于更大规模的科学研究来说相对简单且成本低廉。然而，许多数据库研究论文由于闭源代码、未公开的数据或专有系统而缺乏可重复性。
- en: To enable reproducibility, all configuration parameters must be provided, including
    minor details like the operating system, server installation, version, setup,
    and configuration flags. Additionally, source code for any algorithms or implementations
    should be made available [9].
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 为了实现可重复性，必须提供所有配置参数，包括操作系统、服务器安装、版本、设置和配置标志等细节。此外，任何算法或实现的源代码也应提供[9]。
- en: Most tests in this book will include source code, MySQL configuration files,
    testing tool details, hardware specifications, and OS versions to ensure reproducibility
    and verification of the test results.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 本书中的大多数测试都将包括源代码、MySQL 配置文件、测试工具细节、硬件规格和操作系统版本，以确保可重复性和测试结果的验证。
- en: 6.1.2 Failure To Optimize
  id: totrans-11
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.1.2 未能优化
- en: Benchmarks are commonly used to compare systems or assess the effectiveness
    of new algorithms. Typically, experiments involve comparing a newly proposed system
    against an existing one to demonstrate superior performance.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 基准测试通常用于比较系统或评估新算法的有效性。通常，实验涉及比较一个新提出的系统与现有系统，以证明其优越的性能。
- en: This setup, however, can disincentivize proper optimization of the existing
    system, as poor performance of the current system can make the new system appear
    better. This problem is significant for systems that depend on proper configuration,
    as an improperly configured system can perform much worse than a well-configured
    one.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，这种设置可能会削弱对现有系统进行适当优化的积极性，因为当前系统的性能不佳可能会使新系统看起来更好。对于依赖于正确配置的系统来说，这是一个重要问题，因为配置不当的系统可能比配置良好的系统表现差得多。
- en: Optimizing a DBMS for a specific workload is complex and often requires expertise.
    Even minor optimizations can improve fairness in performance comparisons. Following
    optimization guidelines for benchmarks or involving representatives from the compared
    systems can also help achieve more accurate results [9].
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 为特定工作负载优化数据库管理系统（DBMS）是复杂的，通常需要专业知识。即使是微小的优化也能提高性能比较的公平性。遵循基准测试的优化指南或涉及比较系统的代表也可以帮助实现更准确的结果
    [9]。
- en: 'For performance testing in this book, the following strategies are applied:'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在本书的性能测试中，以下策略被应用：
- en: '**Conduct Pre- and Post-Optimization Comparisons:** Where feasible, perform
    performance comparisons before and after optimization, aiming for minimal variation.'
  id: totrans-16
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**执行优化前后的比较**：在可行的情况下，在优化前后进行性能比较，目标是尽量减少变化。'
- en: '**Match Configuration Parameters:** Align configuration parameters as closely
    as possible with the production environment.'
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**匹配配置参数**：尽可能将配置参数与生产环境对齐。'
- en: '**Conduct Performance Comparisons on Identical Hardware**: Perform tests on
    the same x86 machine in a NUMA environment with identical configurations. Reinitialize
    MySQL data directories and clean SSDs (via TRIM) to avoid interference. Test across
    a range of concurrency levels to assess throughput and determine whether optimizations
    improve performance or scalability.'
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**在相同硬件上执行性能比较**：在NUMA环境中使用相同配置的同一x86机器上进行测试。重新初始化MySQL数据目录并清理SSD（通过TRIM）以避免干扰。在一系列并发级别上进行测试以评估吞吐量并确定优化是否提高了性能或可伸缩性。'
- en: '**Repeat Testing with NUMA Node Binding**: After binding to NUMA node 0, repeat
    the tests to compare performance in an SMP environment.'
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**使用NUMA节点绑定重复测试**：绑定到NUMA节点0后，重复测试以比较SMP环境中的性能。'
- en: '**Test on x86 Machines with NUMA Disabled**: Conduct comparative performance
    testing on x86 machines with identical hardware but with NUMA disabled (in the
    BIOS).'
  id: totrans-20
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**在禁用NUMA的x86机器上测试**：在具有相同硬件但NUMA在BIOS中禁用的x86机器上进行比较性能测试。'
- en: '**Evaluate Performance on ARM Machines**: Test comparative performance on ARM
    machines in a NUMA environment with similar MySQL configurations.'
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**评估ARM机器上的性能**：在具有类似MySQL配置的NUMA环境中测试ARM机器的比较性能。'
- en: '**Verify Consistency with Different Tools**: Use various testing tools to compare
    results and ensure consistency. For example, employ BenchmarkSQL and modified
    versions of tpcc-mysql for TPC-C testing.'
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**使用不同工具验证一致性**：使用各种测试工具比较结果并确保一致性。例如，使用BenchmarkSQL和tpcc-mysql的修改版本进行TPC-C测试。'
- en: '**Assess Performance Under Varying Network Latency**: Examine performance effects
    under different network latency conditions.'
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**评估不同网络延迟下的性能**：检查在不同网络延迟条件下的性能影响。'
- en: '**Test Performance with Different “Thinking Time” Scenarios**: Evaluate how
    performance varies with different “thinking time” scenarios to gauge consistency.'
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**测试不同“思考时间”场景下的性能**：评估性能如何随着不同的“思考时间”场景而变化，以衡量一致性。'
- en: '**Perform Closed-Loop Testing**: Ensure no interference during testing by repeating
    the initial tests and comparing results with the first round. Small differences
    in test results indicate that the environment is relatively stable.'
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**执行闭环测试**：通过重复初始测试并将结果与第一轮比较来确保测试过程中没有干扰。测试结果的小差异表明环境相对稳定。'
- en: '**Verify Bottleneck Interference**: Confirm whether interference from other
    bottlenecks under high concurrency has distorted the performance comparison.'
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**验证瓶颈干扰**：确认在高并发下其他瓶颈的干扰是否扭曲了性能比较。'
- en: '**Analyze Theoretical Basis and Anomalies**: Evaluate whether the performance
    optimization has a theoretical basis and if any anomalies can be explained. Analyze
    the type of optimization, its general applicability, and which environments benefit
    most. Investigate anomalies to determine their causes.'
  id: totrans-27
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**分析理论基础和异常**：评估性能优化是否有理论基础，以及是否可以解释任何异常。分析优化类型、其通用适用性和哪些环境受益最大。调查异常以确定其原因。'
- en: 6.1.3 Overly-specific Tuning
  id: totrans-28
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.1.3 过度特定的调整
- en: These problems can be mitigated by conducting a range of experiments beyond
    standardized benchmarks. While standardized benchmarks provide a useful baseline,
    some systems may be heavily optimized for them, reducing their effectiveness for
    comparison. Thus, additional queries should be tested and measured [9].
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 通过进行超出标准化基准的一系列实验可以缓解这些问题。虽然标准化基准提供了一个有用的基线，但某些系统可能对其进行了大量优化，从而降低了其在比较中的有效性。因此，应该测试和测量额外的查询
    [9]。
- en: 'To address these problems, MySQL configuration should meet the following criteria:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 为了解决这些问题，MySQL配置应满足以下标准：
- en: '**Minimize Impact of Configuration Parameters**: Ensure parameters, like buffer
    pool size, do not hinder other optimizations.'
  id: totrans-31
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**最小化配置参数的影响**：确保参数，如缓冲池大小，不会阻碍其他优化。'
- en: '**Use Default Configurations**: Apply default settings for uncertain parameters,
    such as spin delay.'
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**使用默认配置**：对于不确定的参数，如自旋延迟，应用默认设置。'
- en: '**Match Production Configurations**: Align test settings with production configurations,
    e.g., sync_binlog=1 and innodb_flush_log_at_trx_commit=1.'
  id: totrans-33
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '**匹配生产配置**：将测试设置与生产配置对齐，例如，sync_binlog=1和innodb_flush_log_at_trx_commit=1。'
- en: To overcome the limitations of single-type testing, employ a variety of test
    scenarios. For TPC-C, include tests with varying conflict severity, thinking time,
    and network latency. For SysBench, use tests with Pareto distributions, read/write,
    and write-only operations.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 为了克服单一类型测试的限制，采用多种测试场景。对于TPC-C，包括具有不同冲突严重程度、思考时间和网络延迟的测试。对于SysBench，使用具有帕累托分布、读写和只写操作的测试。
- en: These strategies ensure a comprehensive evaluation of MySQL performance optimizations
    under various conditions, resulting in more robust and reliable results.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 这些策略确保在各种条件下对MySQL性能优化进行全面的评估，从而产生更稳健和可靠的结果。
- en: 6.1.4 Cold vs. Hot Runs
  id: totrans-36
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.1.4 冷启动与热启动
- en: It’s crucial to differentiate between ‘hot’ and ‘cold’ runs. Cold runs, which
    occur when relevant data is being loaded from persistent storage and queries are
    being parsed, are typically slower than hot runs where data is already cached.
    Performance measurements for cold and hot runs should be recorded and reported
    separately due to these differences [9].
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 区分“热”和“冷”启动至关重要。当相关数据从持久存储加载并解析查询时，冷启动通常比数据已经缓存的“热”启动慢。由于这些差异，冷启动和热启动的性能测量应分别记录和报告
    [9]。
- en: For TPC-C testing, all test operations follow a standardized process to ensure
    consistency, and tests are conducted in an environment free from human interference.
    Additionally, to mitigate performance disturbances caused by different environments,
    closed-loop testing is employed to maximize the reliability of the test results
    as much as possible.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 对于TPC-C测试，所有测试操作都遵循标准化流程以确保一致性，测试在无人类干扰的环境中执行。此外，为了减轻不同环境引起的性能干扰，采用闭环测试尽可能最大化测试结果的可信度。
- en: 6.1.5 Cold vs. Warm Runs
  id: totrans-39
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.1.5 冷启动与热启动
- en: Measuring cold runs requires caution to avoid accidentally recording warm runs.
    Proper measurement involves more than just restarting the database server and
    running a query, as operating systems may cache data in memory. The correct method
    is to stop the database server, clear all OS caches, restart the server, and then
    run the queries
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 测量冷启动需要谨慎，以避免意外记录热启动。正确的测量方法不仅仅是重启数据库服务器并运行查询，因为操作系统可能会在内存中缓存数据。正确的方法是停止数据库服务器，清除所有操作系统缓存，重启服务器，然后运行查询
- en: An evaluation test was conducted to assess these impacts. For instance, the
    following figure compares TPC-C throughput and concurrency before and after clearing
    the cache.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 进行了评估测试以评估这些影响。例如，以下图比较了清除缓存前后TPC-C吞吐量和并发性的变化。
- en: '![image-20240830214738439](../Images/1e306547e04518e9f0bbbf57adef96cb.png)'
  id: totrans-42
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240830214738439](../Images/1e306547e04518e9f0bbbf57adef96cb.png)'
- en: Figure 6-1\. Comparison of BenchmarkSQL tests before and after clearing the
    cache.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 图6-1\. 清除缓存前后BenchmarkSQL测试的比较。
- en: From the figure, it can be observed that the throughput after clearing the cache
    is indeed lower compared to the previous throughput.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，清除缓存后的吞吐量确实低于之前的吞吐量。
- en: To mitigate such problems, closed-loop testing was employed, which effectively
    detects anomalies in the environment.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 为了减轻这些问题，采用了闭环测试，这有效地检测了环境中的异常。
- en: 6.1.6 Human Error
  id: totrans-46
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.1.6 人类错误
- en: When evaluating the performance of a newly designed algorithm, it is crucial
    to verify the correctness of the implementation to avoid overlooking bugs that
    may produce incorrect results. A bug might lead to performance metrics being based
    on faulty outcomes, potentially making the algorithm appear more efficient due
    to, for example, less data being processed. This problem is compounded if the
    benchmark is not reproducible, as incorrect implementations may be mistakenly
    accepted as valid.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 当评估新设计算法的性能时，验证实现的正确性至关重要，以避免忽略可能导致错误结果的错误。一个错误可能导致性能指标基于错误的结果，例如，由于处理的数据较少，算法可能看起来更高效。如果基准不可重复，这个问题会变得更加严重，因为错误的实现可能被错误地接受为有效。
- en: Additionally, a program might work correctly for specific datasets but fail
    in general cases due to problems like inadequate overflow handling or hardcoding
    dataset properties. Always verify that the program produces correct results by
    comparing outputs against reference answers from benchmark specifications and
    checking results with varying data [9].
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，一个程序可能对特定数据集工作正常，但由于不足的溢出处理或数据集属性硬编码等问题，在一般情况下可能失败。始终通过将输出与基准规范中的参考答案进行比较，并检查不同数据的结果来验证程序产生正确的结果
    [9]。
- en: For performance testing, it’s essential to consider whether optimization results
    are influenced by other factors. For example, in MySQL 8.0 with the CATS lock
    scheduling algorithm, the performance evaluation could be impacted by extensive
    deadlock logs generated by MySQL.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 对于性能测试，考虑优化结果是否受其他因素影响是至关重要的。例如，在 MySQL 8.0 使用 CATS 锁调度算法时，性能评估可能会受到 MySQL 生成的广泛死锁日志的影响。
- en: 6.2 Comprehensive Testing
  id: totrans-50
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 6.2 综合测试
- en: Performance testing is an extremely complex process. Only through comprehensive
    testing and analysis can errors during the testing process be minimized, allowing
    for a scientific assessment of the value of an optimization.
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 性能测试是一个极其复杂的过程。只有通过综合测试和分析，才能将测试过程中的错误降到最低，从而对优化的价值进行科学评估。
- en: 6.2.1 Testing with Multiple Tools
  id: totrans-52
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.2.1 使用多种工具进行测试
- en: SysBench, BenchmarkSQL, and a modified tpcc-mysql tool are primarily used for
    testing. SysBench tests read/write, write-only, and Pareto distribution scenarios.
    BenchmarkSQL is used for TPC-C testing across various concurrency levels. The
    modified tpcc-mysql tool tests MySQL under extreme conditions.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: SysBench、BenchmarkSQL 和修改后的 tpcc-mysql 工具主要用于测试。SysBench 测试读写、只写和 Pareto 分布场景。BenchmarkSQL
    用于各种并发级别下的 TPC-C 测试。修改后的 tpcc-mysql 工具用于测试极端条件下的 MySQL。
- en: 6.2.2 Identifying Contention-Intensive Tests
  id: totrans-54
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.2.2 识别竞争密集型测试
- en: The more concurrent threads accessing the same data, the greater the contention.
    SysBench Pareto distribution tests are considered high-contention, while SysBench
    uniform distribution tests are low-contention. In modified BenchmarkSQL, testing
    with 1000 warehouses represents low contention, while testing with 10 warehouses
    under the same concurrency level indicates high contention.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 访问相同数据的并发线程越多，竞争越大。SysBench Pareto 分布测试被认为是高竞争，而 SysBench 均匀分布测试被认为是低竞争。在修改后的
    BenchmarkSQL 中，使用 1000 个仓库的测试代表低竞争，而在相同并发级别下使用 10 个仓库的测试表示高竞争。
- en: 6.2.3 Understanding TPC-C Testing Characteristics
  id: totrans-56
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.2.3 理解 TPC-C 测试特性
- en: The TPC-C benchmark is the gold standard for database concurrency control in
    both research and industry [25].
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: TPC-C 基准是研究和工业界数据库并发控制的黄金标准 [25]。
- en: 'Experiment settings can significantly impact evaluation results. In TPC-C:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 实验设置可以显著影响评估结果。在 TPC-C：
- en: Introducing wait time makes experiments I/O intensive.
  id: totrans-59
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 引入等待时间使得实验变得 I/O 密集。
- en: Removing wait time makes experiments CPU/memory intensive.
  id: totrans-60
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 移除等待时间使得实验变得 CPU/内存密集。
- en: Reducing the number of warehouses makes experiments contention intensive.
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 减少仓库数量使得实验竞争密集。
- en: TPC-C can stress test almost every key component of a computer system, but this
    versatility poses challenges for fair comparisons between different systems [8].
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: TPC-C 可以对计算机系统的几乎所有关键组件进行压力测试，但这种多功能性给不同系统之间的公平比较带来了挑战 [8]。
- en: 'At a high level, the following factors reduce contention:'
  id: totrans-63
  prefs: []
  type: TYPE_NORMAL
  zh: 从高层次来看，以下因素可以减少竞争：
- en: More warehouses
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 更多的仓库
- en: Fewer cross-warehouse transactions
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 跨仓库交易数量较少
- en: Fewer workers/users per warehouse
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每个仓库的工人/用户数量较少
- en: Adding wait time
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 添加等待时间
- en: Short or no I/Os within a critical section
  id: totrans-68
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 关键部分内的短或无 I/O
- en: 'In low-contention settings, throughput is limited by the system’s slowest component:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 在低竞争设置中，吞吐量受系统最慢组件的限制：
- en: Disk I/O if data exceeds DRAM size
  id: totrans-70
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果数据超过DRAM大小，则进行磁盘I/O
- en: Network I/O if using traditional TCP stack and data fits in DRAM
  id: totrans-71
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 如果使用传统的TCP堆栈且数据适合在DRAM中
- en: Centralized sequencers or global dependency graphs may also cause scalability
    bottlenecks
  id: totrans-72
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 集中式序列器或全局依赖图也可能导致可扩展性瓶颈
- en: 'Conversely, the following factors increase contention:'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 相反，以下因素会增加竞争：
- en: Fewer warehouses
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 仓库数量较少
- en: More cross-warehouse transactions
  id: totrans-75
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 更多跨仓库交易
- en: More workers/users per warehouse
  id: totrans-76
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每个仓库有更多的工作者/用户
- en: No wait time
  id: totrans-77
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 没有等待时间
- en: Long I/Os within a critical section
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在关键部分内的长I/O
- en: In high-contention settings, throughput is determined by the concurrency control
    mechanism. Systems that can release locks earlier or reduce aborts will have advantages
    [8].
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 在高竞争设置中，吞吐量由并发控制机制决定。能够更早释放锁或减少中止的系统将具有优势 [8]。
- en: The following figure shows the relationship between TPC-C throughput and concurrency
    for different numbers of warehouses. The dark blue curve represents 100 warehouses,
    while the deep red curve represents 1000 warehouses. The figure illustrates that
    throughput for 100 warehouses is significantly lower than for 1000 warehouses
    due to more severe contention in the former scenario.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 下图显示了不同仓库数量下TPC-C吞吐量和并发性的关系。深蓝色曲线代表100个仓库，而深红色曲线代表1000个仓库。图示表明，由于前一种场景中竞争更加激烈，100个仓库的吞吐量显著低于1000个仓库。
- en: '![image-20240829093518737](../Images/b90704f2907b199feae2167e5982f62f.png)'
  id: totrans-81
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829093518737](../Images/b90704f2907b199feae2167e5982f62f.png)'
- en: Figure 6-2\. More warehouses indicate less severe contention.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 图6-2\. 仓库数量越多，竞争越不激烈。
- en: 6.2.4 Incorporating Thinking Time in Testing
  id: totrans-83
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.2.4 在测试中包含思考时间
- en: TPC-C includes a wait time, simulating user behavior with keying and think times
    before each transaction. Each warehouse has ten terminals, one per district, allowing
    a maximum of ten concurrent transactions per warehouse. The vanilla TPC-C does
    not allow tuning these parameters, except for the number of warehouses.
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: TPC-C包括等待时间，通过在每个事务之前模拟用户的按键和思考时间来模拟用户行为。每个仓库有十个终端，每个地区一个，允许每个仓库最多有十个并发事务。vanilla
    TPC-C不允许调整这些参数，除了仓库数量。
- en: Due to the wait time and the ten concurrent user limit per warehouse, the maximal
    throughput per warehouse is limited. To achieve higher throughput, many warehouses
    must be used, which is why systems like OceanBase and Oracle use millions of warehouses.
    For workloads storing large data with low throughput per GB, SSDs can meet throughput
    requirements more cost-effectively than DRAM, aligning with the hardware configurations
    of OceanBase and Oracle. Thus, vanilla TPC-C is an I/O intensive benchmark with
    low contention, as long wait times and limited concurrent users per warehouse
    mean low simultaneous access probability.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 由于等待时间和每个仓库的十个并发用户限制，每个仓库的最大吞吐量是有限的。为了实现更高的吞吐量，必须使用许多仓库，这也是为什么OceanBase和Oracle这样的系统使用数百万个仓库的原因。对于存储大量数据且每GB吞吐量低的负载，SSD比DRAM更经济有效地满足吞吐量要求，与OceanBase和Oracle的硬件配置相匹配。因此，vanilla
    TPC-C是一个以I/O密集型、低竞争为特点的基准测试，因为每个仓库的长时间等待和有限的并发用户意味着同时访问概率低。
- en: Most research addresses contentions, necessitating the removal of wait time
    for higher throughput and contention levels per warehouse. Fewer warehouses are
    used to maintain contention. TPC-C numbers with and without wait time are not
    comparable due to stress testing different system components [8].
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 大多数研究都针对竞争问题，需要移除等待时间以实现更高的吞吐量和每个仓库的竞争级别。为了维持竞争，使用较少的仓库。由于压力测试不同的系统组件 [8]，带有和不带有等待时间的TPC-C数据不可比。
- en: TPC-C testing with a 1ms thinking time (pause before requests) is shown in the
    following figure, illustrating the throughput-concurrency relationship.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 使用1ms思考时间（请求前的暂停）的TPC-C测试结果如图所示，展示了吞吐量与并发性的关系。
- en: '![image-20240829093552414](../Images/c92a376c76f525d036a15671951ee4c6.png)'
  id: totrans-88
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829093552414](../Images/c92a376c76f525d036a15671951ee4c6.png)'
- en: Figure 6-3\. Impact of 1ms thinking time on throughput.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 图6-3\. 1ms思考时间对吞吐量的影响。
- en: From the figure, it can be observed that with a 1ms thinking time, the peak
    throughput is achieved at 1000 concurrency, whereas in normal TPC-C testing, the
    peak is reached at 250 concurrency. Testing with thinking time introduces significant
    differences compared to regular BenchmarkSQL testing and also requires MySQL to
    have better scalability.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，在1毫秒的思考时间内，峰值吞吐量达到1000并发，而在正常的TPC-C测试中，峰值是在250并发时达到。带有思考时间的测试与常规BenchmarkSQL测试相比有显著差异，并且还需要MySQL有更好的可伸缩性。
- en: 6.2.5 Impact of I/O on Testing
  id: totrans-91
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.2.5 I/O对测试的影响
- en: A fully-featured database system must handle network I/Os for protocols like
    2PC, data replication, or Paxos, and disk I/Os for data persistence. Many studies
    omit these I/Os, raising questions about their impact.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 一个功能齐全的数据库系统必须处理像2PC、数据复制或Paxos这样的协议的网络I/O，以及数据持久性的磁盘I/O。许多研究忽略了这些I/O，引发了关于它们影响的问题。
- en: Results may vary with hardware and implementation, but generally, TCP alone
    can support millions of transactions per second if only one packet is needed per
    TPC-C transaction. However, adding protocols like 2PC and replication increases
    packet requirements significantly. For instance, standard Paxos replication to
    three replicas requires at least four packets per transaction, which can overwhelm
    the TCP stack and become a bottleneck for high transaction rates.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 结果可能因硬件和实现方式而异，但通常情况下，如果每个TPC-C事务只需要一个数据包，TCP本身就可以支持每秒数百万次交易。然而，添加像2PC和复制这样的协议会显著增加数据包需求。例如，标准Paxos复制到三个副本至少需要每个事务四个数据包，这可能会压垮TCP堆栈，并成为高交易率的一个瓶颈。
- en: Network and disk latency also impact throughput in contended workloads. Longer
    latencies in critical sections will reduce maximum throughput, with I/O latency
    having a more significant effect.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 网络和磁盘延迟也会影响竞争工作负载中的吞吐量。关键部分的较长延迟会降低最大吞吐量，其中I/O延迟的影响更为显著。
- en: 'However, no solution is perfect: RDMA, for example, involves costly hardware
    and complex software and does not significantly aid in geo-distributed environments
    [8].'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，没有解决方案是完美的：例如，RDMA涉及昂贵的硬件和复杂的软件，并且在地理分布式环境中并没有显著帮助[8]。
- en: 6.2.6 Long-Term Stability Testing
  id: totrans-96
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.2.6 长期稳定性测试
- en: According to the TPC-C benchmark, the database must operate in a steady state
    for eight hours and exceed two hours in the performance collection phase. Additionally,
    the benchmark requires the database to maintain less than 2% jitter over two hours
    of testing [14].
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 根据TPC-C基准测试，数据库必须在稳定状态下运行八小时，并且在性能收集阶段超过两小时。此外，基准测试要求数据库在两小时的测试中保持低于2%的抖动[14]。
- en: 'To meet these stability requirements in MySQL testing, the following measures
    were implemented:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 为了满足MySQL测试中的稳定性要求，采取了以下措施：
- en: Regularly cleaning the binlog to prevent SSD performance degradation due to
    I/O space constraints.
  id: totrans-99
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 定期清理binlog以防止由于I/O空间限制导致的SSD性能下降。
- en: Utilizing a larger number of warehouses.
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 利用更多的仓库数量。
- en: Adding indexes.
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 添加索引。
- en: Deploying multiple SSDs.
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 部署多个SSD。
- en: Following these measures, TPC-C testing was performed using BenchmarkSQL. The
    figure below illustrates the stability test comparison between MySQL 8.0.27 and
    the improved MySQL 8.0.27.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 采取这些措施后，使用BenchmarkSQL进行了TPC-C测试。下面的图表展示了MySQL 8.0.27和改进版MySQL 8.0.27之间的稳定性测试比较。
- en: '![image-degrade2](../Images/953e08c777614e6a8a3a933c2a18ecd4.png)'
  id: totrans-104
  prefs: []
  type: TYPE_IMG
  zh: '![image-degrade2](../Images/953e08c777614e6a8a3a933c2a18ecd4.png)'
- en: 'Figure 6-4\. Comparison of stability tests: MySQL 8.0.27 vs. improved MySQL
    8.0.27.'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 图6-4. 稳定性测试比较：MySQL 8.0.27与改进版MySQL 8.0.27。
- en: From the figure, it is evident that although MySQL and the improved MySQL start
    with similar throughput, the throughput of MySQL decreases more rapidly over time
    than expected, while the improved MySQL remains significantly more stable.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，尽管MySQL和改进版MySQL的吞吐量起始相似，但MySQL的吞吐量随着时间的推移下降得更快，而改进版MySQL则保持了显著更高的稳定性。
- en: 'Additionally, comparisons were made for the improved MySQL at different concurrency
    levels. The figure below shows the throughput over time: the deep blue curve represents
    100 concurrency, while the deep red curve represents 200 concurrency.'
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，还对不同并发级别下的改进版MySQL进行了比较。下面的图表显示了随时间变化的吞吐量：深蓝色曲线代表100并发，而深红色曲线代表200并发。
- en: '![image-degrade3](../Images/d8e605f1164a346eb42467b24a201b1c.png)'
  id: totrans-108
  prefs: []
  type: TYPE_IMG
  zh: '![image-degrade3](../Images/d8e605f1164a346eb42467b24a201b1c.png)'
- en: 'Figure 6-5\. Stability test comparison: 100 vs. 200 concurrency.'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 图6-5. 稳定性测试比较：100并发与200并发。
- en: From the figure, it can be observed that throughput is more stable at 100 concurrency.
    At 200 concurrency, the increased data processing leads to a faster decline in
    throughput, as the larger database scale on a single server results in slower
    access times.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，在100并发时吞吐量更稳定。在200并发时，数据处理的增加导致吞吐量更快地下降，因为单个服务器上的更大数据库规模导致访问时间变慢。
- en: The following figure compares the size of MySQL database files after completing
    an 8-hour test at 100 and 200 concurrency levels.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 以下图表比较了在100和200并发级别完成8小时测试后MySQL数据库文件的大小。
- en: '![image-20240829093934212](../Images/b8be1f192ca5d9f3cc9a01bc3f02f97e.png)'
  id: totrans-112
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829093934212](../Images/b8be1f192ca5d9f3cc9a01bc3f02f97e.png)'
- en: 'Figure 6-6\. Database size comparison: 100 vs. 200 concurrency after 8 hours.'
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 图6-6\. 数据库大小比较：8小时后100与200并发。
- en: From the figure, it is evident that at 200 concurrency, the database size is
    significantly larger than at 100 concurrency. Generally, higher throughput tends
    to reduce stability, and various factors influence stability testing, making broad
    generalizations challenging.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，在200并发时，数据库大小明显大于100并发。通常，更高的吞吐量往往会降低稳定性，而各种因素会影响稳定性测试，使得广泛的概括变得困难。
- en: 6.2.7 Online Traffic Testing
  id: totrans-115
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 6.2.7 在线流量测试
- en: Performance testing often fails to reflect real-world use cases and is typically
    reported with insufficient detail for replication or drawing accurate conclusions
    [39].
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 性能测试往往无法反映真实世界的用例，并且通常报告的细节不足，无法进行复制或得出准确的结论 [39]。
- en: TCPCopy [60] can capture a production workload and replay it on a test system,
    preserving the exact timing, concurrency, and transaction characteristics of the
    original workload. This allows for testing the impact of system changes without
    affecting the production environment.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: TCPCopy [60] 可以捕获生产工作负载并在测试系统上重放，保留原始工作负载的精确时间、并发性和事务特征。这允许在不影响生产环境的情况下测试系统更改的影响。
- en: The following figure illustrates the mechanism of replicating MySQL traffic
    from the online system to the MySQL testing system.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 以下图表说明了将MySQL在线系统中的流量复制到MySQL测试系统的机制。
- en: '![](../Images/de38944f68de14ac8d1542d2cb1c3bda.png)'
  id: totrans-119
  prefs: []
  type: TYPE_IMG
  zh: '![image](../Images/de38944f68de14ac8d1542d2cb1c3bda.png)'
- en: Figure 6-7\. Mechanism for replicating MySQL traffic from production to testing
    systems.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 图6-7\. 从生产系统到测试系统的MySQL流量复制机制。
- en: Testing real-world online traffic is crucial for MySQL, as it effectively reveals
    potential problems such as performance stability, memory leaks, and the robustness
    of new MySQL versions.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 对于MySQL来说，测试真实世界的在线流量至关重要，因为它有效地揭示了潜在问题，如性能稳定性、内存泄漏以及新MySQL版本的健壮性。
- en: '[Next](/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Part3.html)'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: '[下一页](/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Part3.html)'
