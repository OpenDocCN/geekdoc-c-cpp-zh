<html><head></head><body>
<main class="calibre3">
<div id="chapter07" class="author">
<header class="calibre6">
<h2 id="calibre_toc_9" class="calibre7"><span class="first-last">Chapter<span class="first-last"> </span></span><span class="first-last">8<span class="first-last">. </span></span>Behind the process</h2></header></div></main>

<main class="calibre3">
<div id="chapter07" class="author">
<section id="executable_files"><header class="calibre8"><h2 class="calibre7" id="calibre_pb_56"><span class="first-last">1<span class="first-last"> </span></span>Review of executable files</h2></header><p class="releaseinfo">We know that a program running in memory has two major
    components in <em class="calibre5">code</em> (also commonly known as a
    <em class="calibre5">text</em> for historical reasons) and
    <em class="calibre5">data</em>.  We also know, however, an executable
    does not live its life in memory, but spends most of its life as a
    file on a disk waiting to be loaded an run.  Since a file is, in
    essence, simply a contiguous array of bits, all systems come up
    with methods of organising code and data within files for
    on-demand execution.  This file-format is generally referred to as
    a <em class="calibre5">binary</em> or an
    <em class="calibre5">executable</em>.  The bits and bytes of the file
    are generally in a format ready to be placed in memory and
    interpreted directly by processor hardware.</p></section></div></main>

<main class="calibre3">
<div id="chapter07" class="author">
<section id="representing_executables"><header class="calibre8"><h2 class="calibre7" id="calibre_pb_57"><span class="first-last">2<span class="first-last"> </span></span>Representing executable files</h2></header><section id="representing_executables_s1"><header class="calibre8"><h3 class="calibre2"><span class="first-last">2<span class="first-last">.</span>1<span class="first-last"> </span></span>Three Standard Sections</h3></header><p class="releaseinfo">At a minimum, any executable file format will need to
      specify where the code and data are in the binary file.  These
      are the two primary sections within an executable file.</p><p class="releaseinfo">One additional component we have not mentioned until now
      is storage space of uninitialised global variables.  If we
      declare a variable and give it an initial value, this value
      needs to be stored in the executable file so that at program
      start it can be initalised to the correct value.  However many
      variables are uninitialised (or zero) when the program is first
      executed.  Making space for these in the executable and then
      simply storing zero or NULL values is a waste of space,
      needlessly bloating the executable file-size on disk.  Thus most
      binary formats define the concept of a additional
      <code class="computeroutput1">BSS</code> section as a place-holder
      size for zeroed, uninitialised data.  On program load the extra
      memory described by the BSS can be allocated (and set to zero!).
      BSS <em class="calibre5">probably</em> stands for Block Started by
      Symbol, an assembly command for a old IBM computer; the exact
      derivation is probably lost to history.</p></section><section id="representing_executables_s2"><header class="calibre8"><h3 class="calibre2"><span class="first-last">2<span class="first-last">.</span>2<span class="first-last"> </span></span>Binary Format</h3></header><p class="releaseinfo">The executable is created by the toolchain from the source
    code.  This file needs to be in a format explicitly defined such
    that the compiler can create it and the operating system can
    identify it and load into memory, turning it into a running
    process that the operating system can manage.  This
    <em class="calibre5">executable file format</em> can be specific to the
    operating system, as we would not normally expect that a program
    compiled for one system will execute on another (for example, you
    don't expect your Windows programs to run on Linux, or your Linux
    programs to run on OS X).</p><p class="releaseinfo">However, the common thread between all executable file
    formats is that they include a predefined, standardised header
    which describes how program code and data are stored in the rest
    of the file.  In words, it would generally describe "the program
    code starts 20 bytes into this file, and is 50 kilobytes long.
    The program data follows it and is 20 kilobytes long".</p><p class="releaseinfo">In recent times one particular format has become the de facto
      standard for executable representation for modern UNIX type
      systems.  It is called the <code class="computeroutput1">Executable and Linker
      Format</code>, or ELF for short; we'll be looking at
      it in more detail soon.</p></section><section id="representing_executables_s3"><header class="calibre8"><h3 class="calibre2"><span class="first-last">2<span class="first-last">.</span>3<span class="first-last"> </span></span>Binary Format History</h3></header><section id="representing_executables_s3_s1"><header class="calibre8"><h4 class="calibre21"><span class="first-last">2<span class="first-last">.</span>3<span class="first-last">.</span>1<span class="first-last"> </span></span>a.out</h4></header><p class="releaseinfo">ELF was not always the standard; original UNIX systems
      used a file format called
      <code class="computeroutput1">a.out</code>.  We can see the
      vestiges of this if you compile a program without the
      <code class="computeroutput1">-o</code> option to specify an output file name; the
      executable will be created with a default name of
      <code class="computeroutput1">a.out</code><span id="representing_executables_s3_s1_para1_footnote1-fnote">In fact,
      <code class="computeroutput1">a.out</code> is the default output
      filename from the <em class="calibre5">linker</em>.  The compiler
      generally uses randomly generated file names as intermediate
      files for assembly and object code.</span>.</p><p class="releaseinfo"><code class="computeroutput1">a.out</code> is a very simple
	header format that only allows a single data, code and BSS
	section.  As you will come to see, this is insufficient for
	modern systems with dynamic libraries.</p></section><section id="representing_executables_s3_s2"><header class="calibre8"><h4 class="calibre21"><span class="first-last">2<span class="first-last">.</span>3<span class="first-last">.</span>2<span class="first-last"> </span></span>COFF</h4></header><p class="releaseinfo">The Common Object File Format, or COFF, was the
        precursor to ELF.  Its header format was more flexible,
        allowing more (but limited) sections in the file.</p><p class="releaseinfo">COFF also has difficulties with elegant support of
	shared libraries, and ELF was selected as an alternative
	implementation on Linux.</p><p class="releaseinfo">However, COFF lives on in Microsoft Windows as the
	<code class="computeroutput1">Portable Executable</code> or PE
	format.  PE is to Windows as ELF is to Linux.</p></section></section></section></div></main>

<main class="calibre3">
<div id="chapter07" class="author">
<section id="elf"><header class="calibre8"><h2 class="calibre7" id="calibre_pb_58"><span class="first-last">3<span class="first-last"> </span></span>ELF</h2></header><p class="releaseinfo">ELF is an extremely flexible format for representing binary
    code in a system.  By following the ELF standard you can represent
    a kernel binary just as easily as a normal executable or a system
    library.  The same tools can be used to inspect and operate on all
    ELF files and developers who understand the ELF file format can
    translate their skills to most modern UNIX systems.</p><p class="releaseinfo">ELF extends on COFF and gives the header sufficient
    flexibility to define an arbitrary number of sections, each with
    its own properties.  This facilitates easier dynamic linking and
    debugging.</p><div id="elf_fig1" class="figure"><div class="author" summary="ELF Overview"><div class="media"><picture><img src="elf-overview.svg" alt="ELF Overview" class="calibre12"/></picture></div></div><header class="calibre8"><div class="title"><span>Figure<span> </span></span><span>3<span>.</span>1<span> </span></span>ELF Overview</div></header></div><section id="elf_s1"><header class="calibre8"><h3 class="calibre2"><span class="first-last">3<span class="first-last">.</span>1<span class="first-last"> </span></span>ELF File Header</h3></header><p class="releaseinfo">Overall, the file has a <em class="calibre5">file header</em>
        which describes the file in general and then has pointers to
        each of the individual sections that make up the file.  <a href="#elf-header" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>1<span class="sep">.</span>1, </span><span>The ELF Header</span></span></a> shows the description as given in the
        API documentation for ELF32 (the 32-bit form of ELF).  This is
        the layout of the C structure which defines a ELF
        header.</p><div id="elf-header" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="16"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">typedef struct {</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        unsigned char e_ident[EI_NIDENT];</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Half    e_type;</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Half    e_machine;</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Word    e_version;</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Addr    e_entry;</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Off     e_phoff;</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Off     e_shoff;</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Word    e_flags;</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Half    e_ehsize;</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Half    e_phentsize;</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Half    e_phnum;</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Half    e_shentsize;</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Half    e_shnum;</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        Elf32_Half    e_shstrndx;</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">} Elf32_Ehdr;</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>1<span>.</span>1<span> </span></span>The ELF Header</div></header></div><div id="readelf-elf-header" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="24"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ readelf --header /bin/ls</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">ELF Header:</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Magic:   7f 45 4c 46 01 02 01 00 00 00 00 00 00 00 00 00 </code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Class:                             ELF32</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Data:                              2's complement, big endian</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Version:                           1 (current)</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  OS/ABI:                            UNIX - System V</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  ABI Version:                       0</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Type:                              EXEC (Executable file)</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Machine:                           PowerPC</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Version:                           0x1</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Entry point address:               0x10002640</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Start of program headers:          52 (bytes into file)</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Start of section headers:          87460 (bytes into file)</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Flags:                             0x0</code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Size of this header:               52 (bytes)</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Size of program headers:           32 (bytes)</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Number of program headers:         8</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Size of section headers:           40 (bytes)</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Number of section headers:         29</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Section header string table index: 28</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [...]</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>1<span>.</span>2<span> </span></span>The ELF Header, as shown by <span>readelf</span></div></header></div><p class="releaseinfo"><a href="#readelf-elf-header" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>1<span class="sep">.</span>2, </span><span>The ELF Header, as shown by <span>readelf</span></span></span></a> shows a human
        readable form as present by the
        <span>readelf</span> program, which is part of
        <span>GNU binutils</span>.</p><p class="releaseinfo">The <code class="computeroutput1">e_ident</code> array is
        the first thing at the start of any ELF file, and always
        starts with a few "magic" bytes.  The first byte is 0x7F and
        then the next three bytes are "ELF".  You can inspect an ELF
        binary to see this for yourself with something like the
        <code class="computeroutput1">hexdump</code> command.</p><div id="elf-magic" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="4"><pre class="language-c"><span class="line" db-line="1"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code class="calibre13">ianw@mingus:~$ hexdump -C /bin/ls | more</code></span></span>
<span class="line" db-line="2"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code class="calibre13">00000000  7f 45 4c 46 01 02 01 00  00 00 00 00 00 00 00 00  |.ELF............|</code></span></span>
<span class="line" db-line="3"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="4"><span class="ln">  <span class="nsep">|</span></span><span class="ld"><code class="calibre13">... (rest of the program follows) ...</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>1<span>.</span>3<span> </span></span>Inspecting the ELF magic number</div></header></div><p class="releaseinfo">Note the 0x7F to start, then the ASCII encoded "ELF"
        string.  Have a look at the standard and see what the rest of
        the array defines and what the values are in a binary.</p><p class="releaseinfo">Next we have some flags for the type of machine this
        binary is created for.  The first thing we can see is that ELF
        defines different type sized versions, one for 32 bit and one
        for 64 bit versions; here we inspect the 32 bit version.  The
        difference is mostly that on 64 bit machines addresses
        obviously required to be held in 64 bit variables.  We can see
        that the binary has been created for a big endian machine that
        uses 2's complement to represent negative numbers.  Skipping
        down a bit we can see the
        <code class="computeroutput1">Machine</code> tells us this is a
        PowerPC binary.</p><p class="releaseinfo">The apparently innocuous entry point address seems
        straight forward enough; this is the address in memory that
        the program code starts at.  Beginning C programmers are told
        that <em class="calibre5">main()</em> is the first program called
        in your program.  Using the entry point address we can
        actually verify that it <em class="calibre5">isn't</em>.</p><div id="entry-point" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="20"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ cat test.c</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#include &lt;stdio.h&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int main(void)</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">{</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        printf("main is : %p\n", &amp;main);</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        return 0;</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gcc -Wall -o test test.c</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ ./test</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">main is : 0x10000430</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ readelf --headers ./test | grep 'Entry point'</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Entry point address:               0x100002b0</code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump --disassemble ./test | grep 100002b0</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">100002b0 &lt;_start&gt;:</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">100002b0:       7c 29 0b 78     mr      r9,r1</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>1<span>.</span>4<span> </span></span>Investigating the entry point</div></header></div><p class="releaseinfo">In <a href="#entry-point" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>1<span class="sep">.</span>4, </span><span>Investigating the entry point</span></span></a> we can see that the
        entry point is actually a function called
        <code class="computeroutput1">_start</code>.  Our program didn't
        define this at all, and the leading underscore suggests that
        it is in a separate <em class="calibre5">namespace</em>.  We
        examine how a program starts up in detail in <a href="csbu-print_split_055.html#startup" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>8<span class="sep">.</span>2, </span><span>Starting the program</span></span></a>.</p><p class="releaseinfo">After that the header contains pointers to where in the
        file other important parts of the ELF file start, like a table
        of contents.</p></section><section id="symbols_and_relocations"><header class="calibre8"><h3 class="calibre2"><span class="first-last">3<span class="first-last">.</span>2<span class="first-last"> </span></span>Symbols and Relocations</h3></header><p class="releaseinfo">The ELF specification provides for <em class="calibre5">symbol
        tables</em> which are simply mappings of strings
        (symbols) to locations in the file.  Symbols are required for
        linking; for example assigning a value to a variable
        <code class="computeroutput1">foo</code> declared as
        <code class="computeroutput1">extern int foo;</code> would require
        the linker to find the address of
        <code class="computeroutput1">foo</code>, which would involve
        looking up "foo" in the symbol table and finding the
        address.</p><p class="releaseinfo">Closely related to symbols are
        <em class="calibre5">relocations</em>.  A relocation is simply a
        blank space left to be patched up later.  In the previous
        example, until the address of
        <code class="computeroutput1">foo</code> is known it can not be
        used.  However, on a 32-bit system, we know the
        <em class="calibre5">address</em> of
        <code class="computeroutput1">foo</code> must be a 4-byte value,
        so any time the compiler needs to use that address (to say,
        assign a value) it can simply leave 4-bytes of blank space and
        keep a relocation that essentially says to the linker "place
        the real value of "foo" into the 4 bytes at this address".  As
        mentioned, this requires the symbol "foo" to be resolved.
        <a href="csbu-print_split_058.html#dynamic_relocations" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>2<span class="sep">.</span>1, </span><span>Relocations</span></span></a> contains further
        information on relocations.
	</p></section><section id="elf_s3"><header class="calibre8"><h3 class="calibre2"><span class="first-last">3<span class="first-last">.</span>3<span class="first-last"> </span></span>Sections and Segments</h3></header><p class="releaseinfo">The ELF format specifies two "views" of an ELF file —
        that which is used for linking and that which is used for
        execution.  This affords significant flexibility for systems
        designers.</p><p class="releaseinfo">We talk about <em class="calibre5">sections</em> in object
        code waiting to be linked into an executable.  One or more
        sections map to a <em class="calibre5">segment</em> in the
        executable.</p><section id="elf_s3_s1"><header class="calibre8"><h4 class="calibre21"><span class="first-last">3<span class="first-last">.</span>3<span class="first-last">.</span>1<span class="first-last"> </span></span>Segments</h4></header><p class="releaseinfo">As we have done before, it is sometimes easier to look
          at the higher level of abstraction (segments) before
          inspecting the lower layers.</p><p class="releaseinfo">As we mentioned the ELF file has an header that
          describes the overall layout of the file.  The ELF header
          actually points to another group of headers called the
          <em class="calibre5">program headers</em>.  These headers
          describe to the operating system anything that might be
          required for it to load the binary into memory and execute
          it.  Segments are described by program headers, but so are
          some other things required to get the executable
          running.</p><div id="program-header" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="10"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">typedef struct {</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word p_type;</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Off  p_offset;</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Addr p_vaddr;</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Addr p_paddr;</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word p_filesz;</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word p_memsz;</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word p_flags;</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word p_align;</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>3<span>.</span>1<span>.</span>1<span> </span></span>The Program Header</div></header></div><p class="releaseinfo">The definition of the program header is seen in <a href="#program-header" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>3<span class="sep">.</span>1<span class="sep">.</span>1, </span><span>The Program Header</span></span></a>.  You might have noticed from
          the ELF header definition above how there were fields
          <code class="computeroutput1">e_phoff</code>,
          <code class="computeroutput1">e_phnum</code> and
          <code class="computeroutput1">e_phentsize</code>; these are
          simply the offset in the file where the program headers
          start, how many program headers there are and how big each
          program header is.  With these three bits of information you
          can easily find and read the program headers.</p><p class="releaseinfo">Program headers more than just segments.  The
          <code class="computeroutput1">p_type</code> field defines just
          what the program header is defining.  For example, if this
          field is <code class="computeroutput1">PT_INTERP</code> the
          header is defined as meaning a string pointer to an
          <em class="calibre5">interpreter</em> for the binary file.  We
          discussed compiled versus interpreted languages previously
          and made the distinction that a compiler builds a binary
          which can be run in a stand alone fashion.  Why should it
          need an interpreter?  As always, the true picture is a
          little more complicated.  There are several reasons why a
          modern system wants flexibility when loading executable
          files, and to do this some information can only be
          adequately acquired at the actual time the program is set up
          to run.  We see this in future chapters where we look into
          dynamic linking.  Consequently some minor changes might need
          to be made to the binary to allow it to work properly at
          runtime.  Thus the usual interpreter of a binary file is the
          <em class="calibre5">dynamic loader</em>, so called because it
          takes the final steps to complete loading of the executable
          and prepare the binary image for running.
	  </p><p class="releaseinfo">Segments are described with a value of
          <code class="computeroutput1">PT_LOAD</code> in the
          <code class="computeroutput1">p_type</code> field.  Each segment
          is then described by the other fields in the program header.
          The <code class="computeroutput1">p_offset</code> field tells
          you how far into the file on disk the data for the segment
          is.  The <code class="computeroutput1">p_vaddr</code> field
          tells you what address that data is to live at in virtual
          memory (<code class="computeroutput1">p_addr</code> describes
          the physical address, which is only really useful for small
          embedded systems that do not implement virtual memory).  The
          two flags <code class="computeroutput1">p_filesz</code> and
          <code class="computeroutput1">p_memsz</code> work to tell you
          how big the segment is on disk and how big it should be in
          memory.  If the memory size is greater than the disk size,
          then the overlap should be filled with zeros.  In this way
          you can save considerable space in your binaries by not
          having to waste space for empty global variables.  Finally
          <code class="computeroutput1">p_flags</code> indicates the
          permissions on the segment.  Execute, read and write
          permissions can be specified in any combination; for example
          code segments should be marked as read and execute only,
          data sections as read and write with no execute.
	  </p><p class="releaseinfo">There are a few other segment types defined in the
          program headers, they are described more fully in the
          standards specification.</p></section><section id="sections"><header class="calibre8"><h4 class="calibre21"><span class="first-last">3<span class="first-last">.</span>3<span class="first-last">.</span>2<span class="first-last"> </span></span>Sections</h4></header><p class="releaseinfo">As we have mentioned, sections make up segments.
          Sections are a way to organise the binary into logical areas
          to communicate information between the compiler and the
          linker.  In some special binaries, such as the Linux kernel,
          sections are used in more specific ways (see <a href="csbu-print_split_053.html#extra_sections" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>6<span class="sep">.</span>2, </span><span>Custom sections</span></span></a>).</p><p class="releaseinfo">We've seen how segments ultimately come down to a blob
          of data in a file on disk with some descriptions about where
          it should be loaded and what permissions it has.  Sections
          have a similar header to segments, as shown in <a href="#section-header" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>3<span class="sep">.</span>2<span class="sep">.</span>1, </span><span>Sections </span></span></a>.</p><div id="section-header" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="12"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">typedef struct {</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word sh_name;</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word sh_type;</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word sh_flags;</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Addr sh_addr;</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Off  sh_offset;</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word sh_size;</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word sh_link;</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word sh_info;</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word sh_addralign;</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">          Elf32_Word sh_entsize;</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>3<span>.</span>2<span>.</span>1<span> </span></span>Sections </div></header></div><p class="releaseinfo">Sections have a few more types defined for the
          <code class="computeroutput1">sh_type</code> field; for example
          a section of type
          <code class="computeroutput1">SH_PROGBITS</code> is defined as a
          section that hold binary data for use by the program.  Other
          flags say if this section is a symbol table (used by the
          linker or debugger for example) or maybe something for the
          dynamic loader.  There are also more attributes, such as the
          <em class="calibre5">allocate</em> attribute which flags that
          this section will need memory allocated for it.</p><p class="releaseinfo">Below we will examine the program listed in <a href="#section" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>3<span class="sep">.</span>2<span class="sep">.</span>2, </span><span>Sections </span></span></a>.</p><div id="section" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="14"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#include &lt;stdio.h&gt;</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int big_big_array[10*1024*1024];</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">char *a_string = "Hello, World!";</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int a_var_with_value = 0x100;</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int main(void)</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">{</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">	big_big_array[0] = 100;</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">	printf("%s\n", a_string);</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">	a_var_with_value += 20;</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>3<span>.</span>2<span>.</span>2<span> </span></span>Sections </div></header></div><p class="releaseinfo"><a href="#section-readelf" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>3<span class="sep">.</span>2<span class="sep">.</span>3, </span><span>Sections readelf output </span></span></a> shows the output of
          <span>readelf</span> with some parts stripped
          clarity.  Using this output we can analyse each part of our
          simple program and see where it ends up in the final output
          binary.</p><div id="section-readelf" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="64"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ readelf --all ./sections</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">ELF Header:</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> ...</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Size of section headers:           40 (bytes)</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Number of section headers:         37</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Section header string table index: 34</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Section Headers:</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 1] .interp           PROGBITS        10000114 000114 00000d 00   A  0   0  1</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 2] .note.ABI-tag     NOTE            10000124 000124 000020 00   A  0   0  4</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 3] .hash             HASH            10000144 000144 00002c 04   A  4   0  4</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 4] .dynsym           DYNSYM          10000170 000170 000060 10   A  5   1  4</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 5] .dynstr           STRTAB          100001d0 0001d0 00005e 00   A  0   0  1</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 6] .gnu.version      VERSYM          1000022e 00022e 00000c 02   A  4   0  2</code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 7] .gnu.version_r    VERNEED         1000023c 00023c 000020 00   A  5   1  4</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 8] .rela.dyn         RELA            1000025c 00025c 00000c 0c   A  4   0  4</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 9] .rela.plt         RELA            10000268 000268 000018 0c   A  4  25  4</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [10] .init             PROGBITS        10000280 000280 000028 00  AX  0   0  4</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [11] .text             PROGBITS        100002b0 0002b0 000560 00  AX  0   0 16</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [12] .fini             PROGBITS        10000810 000810 000020 00  AX  0   0  4</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [13] .rodata           PROGBITS        10000830 000830 000024 00   A  0   0  4</code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [14] .sdata2           PROGBITS        10000854 000854 000000 00   A  0   0  4</code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [15] .eh_frame         PROGBITS        10000854 000854 000004 00   A  0   0  4</code></span></span>
<span class="line" db-line="26"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [16] .ctors            PROGBITS        10010858 000858 000008 00  WA  0   0  4</code></span></span>
<span class="line" db-line="27"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [17] .dtors            PROGBITS        10010860 000860 000008 00  WA  0   0  4</code></span></span>
<span class="line" db-line="28"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [18] .jcr              PROGBITS        10010868 000868 000004 00  WA  0   0  4</code></span></span>
<span class="line" db-line="29"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [19] .got2             PROGBITS        1001086c 00086c 000010 00  WA  0   0  1</code></span></span>
<span class="line" db-line="30"><span class="ln">30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [20] .dynamic          DYNAMIC         1001087c 00087c 0000c8 08  WA  5   0  4</code></span></span>
<span class="line" db-line="31"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [21] .data             PROGBITS        10010944 000944 000008 00  WA  0   0  4</code></span></span>
<span class="line" db-line="32"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [22] .got              PROGBITS        1001094c 00094c 000014 04 WAX  0   0  4</code></span></span>
<span class="line" db-line="33"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [23] .sdata            PROGBITS        10010960 000960 000008 00  WA  0   0  4</code></span></span>
<span class="line" db-line="34"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [24] .sbss             NOBITS          10010968 000968 000000 00  WA  0   0  1</code></span></span>
<span class="line" db-line="35"><span class="ln">35 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [25] .plt              NOBITS          10010968 000968 000060 00 WAX  0   0  4</code></span></span>
<span class="line" db-line="36"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [26] .bss              NOBITS          100109c8 000968 2800004 00  WA  0   0  4</code></span></span>
<span class="line" db-line="37"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [27] .comment          PROGBITS        00000000 000968 00018f 00      0   0  1</code></span></span>
<span class="line" db-line="38"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [28] .debug_aranges    PROGBITS        00000000 000af8 000078 00      0   0  8</code></span></span>
<span class="line" db-line="39"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [29] .debug_pubnames   PROGBITS        00000000 000b70 000025 00      0   0  1</code></span></span>
<span class="line" db-line="40"><span class="ln">40 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [30] .debug_info       PROGBITS        00000000 000b95 0002e5 00      0   0  1</code></span></span>
<span class="line" db-line="41"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [31] .debug_abbrev     PROGBITS        00000000 000e7a 000076 00      0   0  1</code></span></span>
<span class="line" db-line="42"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [32] .debug_line       PROGBITS        00000000 000ef0 0001de 00      0   0  1</code></span></span>
<span class="line" db-line="43"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [33] .debug_str        PROGBITS        00000000 0010ce 0000f0 01  MS  0   0  1</code></span></span>
<span class="line" db-line="44"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [34] .shstrtab         STRTAB          00000000 0011be 00013b 00      0   0  1</code></span></span>
<span class="line" db-line="45"><span class="ln">45 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [35] .symtab           SYMTAB          00000000 0018c4 000c90 10     36  65  4</code></span></span>
<span class="line" db-line="46"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [36] .strtab           STRTAB          00000000 002554 000909 00      0   0  1</code></span></span>
<span class="line" db-line="47"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Key to Flags:</code></span></span>
<span class="line" db-line="48"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  W (write), A (alloc), X (execute), M (merge), S (strings)</code></span></span>
<span class="line" db-line="49"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  I (info), L (link order), G (group), x (unknown)</code></span></span>
<span class="line" db-line="50"><span class="ln">50 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  O (extra OS processing required) o (OS specific), p (processor specific)</code></span></span>
<span class="line" db-line="51"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="52"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There are no section groups in this file.</code></span></span>
<span class="line" db-line="53"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> ...</code></span></span>
<span class="line" db-line="54"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="55"><span class="ln">55 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Symbol table '.symtab' contains 201 entries:</code></span></span>
<span class="line" db-line="56"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   Num:    Value  Size Type    Bind   Vis      Ndx Name</code></span></span>
<span class="line" db-line="57"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">...</code></span></span>
<span class="line" db-line="58"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    99: 100109cc 0x2800000 OBJECT  GLOBAL DEFAULT   26 big_big_array</code></span></span>
<span class="line" db-line="59"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">...</code></span></span>
<span class="line" db-line="60"><span class="ln">60 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   110: 10010960     4 OBJECT  GLOBAL DEFAULT   23 a_string</code></span></span>
<span class="line" db-line="61"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">...</code></span></span>
<span class="line" db-line="62"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   130: 10010964     4 OBJECT  GLOBAL DEFAULT   23 a_var_with_value</code></span></span>
<span class="line" db-line="63"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">...</code></span></span>
<span class="line" db-line="64"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   144: 10000430    96 FUNC    GLOBAL DEFAULT   11 main</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>3<span>.</span>2<span>.</span>3<span> </span></span>Sections readelf output </div></header></div><p class="releaseinfo">Firstly, let us look at the variable
          <code class="computeroutput1">big_big_array</code>, which as the
          name suggests is a fairly large global array.  If we skip
          down to the symbol table we can see that the variable is at
          location <code class="computeroutput1">0x100109cc</code> which
          we can correlate to the
          <code class="computeroutput1">.bss</code> section in the section
          listing, since it starts just below it at
          <code class="computeroutput1">0x100109c8</code>.  Note the size,
          and how it is quite large.  We mentioned that BSS is a
          standard part of a binary image since it would be silly to
          require that binary on disk have 10 megabytes of space
          allocated to it, when all of that space is going to be zero.
          Note that this section has a type of
          <code class="computeroutput1">NOBITS</code> meaning that it does
          not have any bytes on disk.</p><p class="releaseinfo">Thus the <code class="computeroutput1">.bss</code> section
          is defined for global variables whose value should be zero
          when the program starts.  We have seen how the memory size
          can be different to the on disk size in our discussion of
          segments; variables being in the
          <code class="computeroutput1">.bss</code> section are an
          indication that they will be given zero value on program
          start.</p><p class="releaseinfo">The <code class="computeroutput1">a_string</code> variable
          lives in the <code class="computeroutput1">.sdata</code>
          section, which stands for <em class="calibre5">small data</em>.
          Small data (and the corresponding
          <code class="computeroutput1">.sbss</code> section) are sections
          available on some architectures where data can be reached by
          an offset from some known pointer.  This means a fixed-value
          can be added to the base-address, making it faster to get to
          data in the sections as there are no extra lookups and
          loading of addresses into memory required.  Most
          architectures are limited to the size of immediate values
          you can add to a register (e.g. if performing the
          instruction <code class="computeroutput1">r1 = add r2,
          70;</code>, 70 is an <em class="calibre5">immediate
          value</em>, as opposed to say, adding two values
          stored in registers <code class="computeroutput1">r1 = add
          r2,r3</code>) and can thus only offset a certain
          "small" distance from an address.  We can also see that our
          <code class="computeroutput1">a_var_with_value</code> lives in
          the same place.</p><p class="releaseinfo"><code class="computeroutput1">main</code> however lives in
          the <code class="computeroutput1">.text</code> section, as we
          expect (remember the name "text" and "code" are used
          interchangeably to refer to a program in memory.</p></section><section id="elf_s3_s3"><header class="calibre8"><h4 class="calibre21"><span class="first-last">3<span class="first-last">.</span>3<span class="first-last">.</span>3<span class="first-last"> </span></span>Sections and Segments together</h4></header><div id="sections-segments" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="28"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ readelf --segments /bin/ls</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Elf file type is EXEC (Executable file)</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Entry point 0x100026c0</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There are 8 program headers, starting at offset 52</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Program Headers:</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  PHDR           0x000034 0x10000034 0x10000034 0x00100 0x00100 R E 0x4</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  INTERP         0x000154 0x10000154 0x10000154 0x0000d 0x0000d R   0x1</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">      [Requesting program interpreter: /lib/ld.so.1]</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x000000 0x10000000 0x10000000 0x14d5c 0x14d5c R E 0x10000</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x014d60 0x10024d60 0x10024d60 0x002b0 0x00b7c RWE 0x10000</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  DYNAMIC        0x014f00 0x10024f00 0x10024f00 0x000d8 0x000d8 RW  0x4</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  NOTE           0x000164 0x10000164 0x10000164 0x00020 0x00020 R   0x4</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  GNU_EH_FRAME   0x014d30 0x10014d30 0x10014d30 0x0002c 0x0002c R   0x4</code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x4</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> Section to Segment mapping:</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Segment Sections...</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   00</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   01     .interp</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   02     .interp .note.ABI-tag .hash .dynsym .dynstr .gnu.version .gnu.version_ r .rela.dyn .rela.plt .init .text .fini .rodata .eh_frame_hdr</code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   03     .data .eh_frame .got2 .dynamic .ctors .dtors .jcr .got .sdata .sbss .p lt .bss</code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   04     .dynamic</code></span></span>
<span class="line" db-line="26"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   05     .note.ABI-tag</code></span></span>
<span class="line" db-line="27"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   06     .eh_frame_hdr</code></span></span>
<span class="line" db-line="28"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   07</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>3<span>.</span>3<span>.</span>3<span>.</span>1<span> </span></span>Sections and Segments</div></header></div><p class="releaseinfo"><a href="#sections-segments" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>3<span class="sep">.</span>3<span class="sep">.</span>1, </span><span>Sections and Segments</span></span></a> shows how
          <code class="computeroutput1">readelf</code> shows us the
          segments and section mappings in the ELF file for the binary
          <code class="computeroutput1">/bin/ls</code>. </p><p class="releaseinfo">Skipping to the bottom of the output, we can see what
          sections have been moved into what segments.  So, for
          example the <code class="computeroutput1">.interp</code> section
          is placed into an <code class="computeroutput1">INTERP</code>
          flagged segment.  Notice that readelf tells us it is
          requesting the interpreter
          <code class="computeroutput1">/lib/ld.so.1</code>; this is the
          dynamic linker which is run to prepare the binary for
          execution.</p><p class="releaseinfo">Looking at the two
          <code class="computeroutput1">LOAD</code> segments we can see
          the distinction between text and data.  Notice how the first
          one has only "read" and "execute" permissions, whilst the
          next one has read, write and execute permissions?  These
          describe the code (r/w) and data (r/w/e) segments.</p><p class="releaseinfo">But data should not need to be executable!  Indeed, on
          most architectures (for example, the most common x86) the
          data section will not be marked as having the data section
          executable.  However, the example output above was taken
          from a PowerPC machine which has a slightly different
          programming model (ABI, see below) requiring that the data
          section be executable <span id="elf_s3_s3_para4_footnote1-fnote">For those that are
          curious, the PowerPC ABI calls stubs for functions in
          dynamic libraries directly in the GOT, rather than having
          them bounce through a separate PLT entry.  Thus the
          processor needs execute permissions for the GOT section,
          which you can see is embedded in the data segment.  This
          should make sense after reading the dynamic linking
          chapter!</span>.  Such is the life of a systems
          programmer, where rules were made to be broken!</p><p class="releaseinfo">The other interesting thing to note is that the file
          size is the same as the memory size for the code segment,
          however memory size is greater than the file size for the
          data segment.  This comes from the BSS section which holds
          zeroed global variables.</p></section></section></section></div></main>

<main class="calibre3">
<div id="chapter07" class="author">
<section id="executables"><header class="calibre8"><h2 class="calibre7" id="calibre_pb_59"><span class="first-last">4<span class="first-last"> </span></span>ELF Executables</h2></header><p class="releaseinfo">Executables are of course one of the primary uses of the ELF
      format.  Contained within the <em class="calibre5">binary</em> is
      everything required for the operating system to execute the
      code as intended.</p><p class="releaseinfo">Since an executable is designed to be run in a process with
    a unique address space (see <a href="csbu-print_split_028.html#chapter05" class="xref pcalibre"><span><span>Chapter<span class="sep"> </span></span><span>6, </span><span>Virtual Memory</span></span></a>) the
    code can make assumptions about where the various parts of the
    program will be loaded in memory.  <a href="#elf_executable" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>4<span class="sep">.</span>1, </span><span>Segments of an executable file</span></span></a> shows an example using the
    <span>readelf</span> tool to examine the segments of
    an executable file.  We can see the virtual addresses at which the
    <code class="computeroutput1">LOAD</code> segments are required to be
    placed at.  We can further see that one segment is for code
    — it has read and execute permissions only — and one
    is for data, unsurprisingly with read and write permissions, but
    importantly no execute permissions (without execute permissions,
    even if a bug allowed an attacker to introduce arbitrary data the
    pages backing it would not be marked with execute permissions, and
    most processors will hence disallow any execution of code in those
    pages).</p><div id="elf_executable" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="37"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ readelf --segments /bin/ls</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Elf file type is EXEC (Executable file)</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Entry point 0x4046d4</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There are 8 program headers, starting at offset 64</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Program Headers:</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Type           Offset             VirtAddr           PhysAddr</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 FileSiz            MemSiz              Flags  Align</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  PHDR           0x0000000000000040 0x0000000000400040 0x0000000000400040</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 0x00000000000001c0 0x00000000000001c0  R E    8</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  INTERP         0x0000000000000200 0x0000000000400200 0x0000000000400200</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 0x000000000000001c 0x000000000000001c  R      1</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 0x0000000000019ef4 0x0000000000019ef4  R E    200000</code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x000000000001a000 0x000000000061a000 0x000000000061a000</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 0x000000000000077c 0x0000000000001500  RW     200000</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  DYNAMIC        0x000000000001a028 0x000000000061a028 0x000000000061a028</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 0x00000000000001d0 0x00000000000001d0  RW     8</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  NOTE           0x000000000000021c 0x000000000040021c 0x000000000040021c</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 0x0000000000000044 0x0000000000000044  R      4</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  GNU_EH_FRAME   0x0000000000017768 0x0000000000417768 0x0000000000417768</code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 0x00000000000006fc 0x00000000000006fc  R      4</code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000</code></span></span>
<span class="line" db-line="26"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">                 0x0000000000000000 0x0000000000000000  RW     8</code></span></span>
<span class="line" db-line="27"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="28"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> Section to Segment mapping:</code></span></span>
<span class="line" db-line="29"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Segment Sections...</code></span></span>
<span class="line" db-line="30"><span class="ln">30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   00     </code></span></span>
<span class="line" db-line="31"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   01     .interp </code></span></span>
<span class="line" db-line="32"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   02     .interp .note.ABI-tag .note.gnu.build-id .hash .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .text .fini .rodata .eh_frame_hdr .eh_frame </code></span></span>
<span class="line" db-line="33"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   03     .ctors .dtors .jcr .dynamic .got .got.plt .data .bss </code></span></span>
<span class="line" db-line="34"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   04     .dynamic </code></span></span>
<span class="line" db-line="35"><span class="ln">35 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   05     .note.ABI-tag .note.gnu.build-id </code></span></span>
<span class="line" db-line="36"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   06     .eh_frame_hdr </code></span></span>
<span class="line" db-line="37"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">   07     </code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>4<span>.</span>1<span> </span></span>Segments of an executable file</div></header></div><p class="releaseinfo">The program segments must be loaded at these addresses; the
    last step of the linker is to resolve most relocations (<a href="csbu-print_split_050.html#symbols_and_relocations" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>3<span class="sep">.</span>2, </span><span>Symbols and Relocations</span></span></a>) and patch them with the
    assumed absolute addresses — the data describing the
    relocation is then discarded in the final binary and there is no
    longer a way to find this information.
    </p><p class="releaseinfo">In reality, executables generally have external dependencies
      on <em class="calibre5">shared libraries</em>, or pieces of common
      code abstracted and shared among the entire system —
      almost all of the confusing parts of <a href="#elf_executable" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>4<span class="sep">.</span>1, </span><span>Segments of an executable file</span></span></a> relate to the use of shared
      libraries.  Libraries are discussed in <a href="csbu-print_split_052.html#libraries" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>5, </span><span>Libraries</span></span></a>, dynamic libraries in <a href="csbu-print_split_055.html#chapter08" class="xref pcalibre"><span><span>Chapter<span class="sep"> </span></span><span>9, </span><span>Dynamic Linking</span></span></a>.</p></section></div></main>

<main class="calibre3">
<div id="chapter07" class="author">
<section id="libraries"><header class="calibre8"><h2 class="calibre7" id="calibre_pb_60"><span class="first-last">5<span class="first-last"> </span></span>Libraries</h2></header><p class="releaseinfo">Developers soon tired of having to write everything from
      scratch, so one of the first inventions of computer science was
      <em class="calibre5">libraries</em>.</p><p class="releaseinfo">A library is simply a collection of functions which you
      can call from your program.  Obviously a library has many
      advantages, not least of which is that you can save much time by
      reusing work someone else has already done and generally be more
      confident that it has fewer bugs (since probably many other
      people use the libraries too, and you benefit from having them
      finding and fixing bugs).  A library is exactly like an
      executable, except instead of running directly the library
      functions are invoked with parameters from your
      executable.</p><section id="libraries_s1"><header class="calibre8"><h3 class="calibre2"><span class="first-last">5<span class="first-last">.</span>1<span class="first-last"> </span></span>Static Libraries</h3></header><p class="releaseinfo">The most straight forward way of using a library function is
      to have the object files from the library linked directly into
      your final executable, just as with those you have compiled
      yourself.  When linked like this the library is called a
      <em class="calibre5">static</em> library, because the library will
      remain unchanged unless the program is recompiled.</p><p class="releaseinfo">This is the most straight forward way of using a library
      as the final result is a simple executable with no
      dependencies.</p><section id="libraries_s1_s1"><header class="calibre8"><h4 class="calibre21"><span class="first-last">5<span class="first-last">.</span>1<span class="first-last">.</span>1<span class="first-last"> </span></span>Inside static libraries</h4></header><p class="releaseinfo">A static library is simply a group of object files.  The
	object files are kept in an <em class="calibre5">archive</em>,
	which leads to their usual <code class="computeroutput1">.a</code>
	suffix extension.  You can think of archives as similar to a
	<code class="computeroutput1">zip</code> file, but without compression.</p><p class="releaseinfo">Below we show the creation of basic static library and
	introduce some common tools for working with libraries.</p><div id="libraries_s1_s1_ex1" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="38"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ cat library.c</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/* Library Function */</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int function(int input)</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">{</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        return input + 10;</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ cat library.h</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/* Function Definition */</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int function(int);</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ cat program.c</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#include &lt;stdio.h&gt;</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/* Library header file */</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#include "library.h"</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int main(void)</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">{</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        int d = function(100);</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">        printf("%d\n", d);</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gcc -c library.c</code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ ar rc libtest.a library.o</code></span></span>
<span class="line" db-line="26"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ ranlib ./libtest.a</code></span></span>
<span class="line" db-line="27"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ nm --print-armap ./libtest.a</code></span></span>
<span class="line" db-line="28"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="29"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Archive index:</code></span></span>
<span class="line" db-line="30"><span class="ln">30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">function in library.o</code></span></span>
<span class="line" db-line="31"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="32"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">library.o:</code></span></span>
<span class="line" db-line="33"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">00000000 T function</code></span></span>
<span class="line" db-line="34"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="35"><span class="ln">35 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gcc -L . program.c -ltest -o program</code></span></span>
<span class="line" db-line="36"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="37"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ ./program</code></span></span>
<span class="line" db-line="38"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">110</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>5<span>.</span>1<span>.</span>1<span>.</span>1<span> </span></span>Creating and using a static library</div></header></div><p class="releaseinfo">Firstly we compile our library to an object file, just
        as we have seen in the previous chapter.</p><p class="releaseinfo">Notice that we define the library API in the header
	file.  The API consists of function definitions for the
	functions in the library; this is so that the compiler knows
	what types the functions take when building object files that
	reference the library
	(e.g. <code class="computeroutput1">program.c</code>, which
	<code class="computeroutput1">#include</code>s the header
	file).</p><p class="releaseinfo">We create the library <span>ar</span>
	(short for "archive") command.  By convention static library
	file names are prefixed with
	<code class="computeroutput1">lib</code> and have the extension
	<code class="computeroutput1">.a</code>.  The
	<code class="computeroutput1">c</code> argument tells the program
	to create the archive, and <code class="computeroutput1">a</code>
	tells archive to add the object files specified into the
	library file.<span id="libraries_s1_s1_para5_footnote1-fnote">Archives created with
	<span>ar</span> pop up in a few different places
	around Linux systems other than just creating static
	libraries.  One widely used application is in the
	<code class="computeroutput1">.deb</code> packaging format used
	with Debian, Ubuntu and some other Linux systems is one
	example.  <code class="computeroutput1">debs</code> use archives
	to keep all the application files together in the one package
	file.  RedHat RPM packages use an alternate but similar format
	called <span>cpio</span>.  Of course the
	canonical application for keeping files together is the
	<code class="computeroutput1">tar</code> file, which is a common
	format to distribute source code.</span></p><p class="releaseinfo">Next we use the <span>ranlib</span>
	application to make a header in the library with the symbols
	of the object file contents.  This helps the compiler to
	quickly reference symbols; in the case where we just have one
	this step may seem a little redundant; however a large library
	may have thousands of symbols meaning an index can
	significantly speed up finding references.  We inspect this
	new header with the <span>nm</span> application.
	We see the <code class="computeroutput1">function</code> symbol
	for the <code class="computeroutput1">function()</code> function
	at offset zero, as we expect.</p><p class="releaseinfo">You then specify the library to the compiler with
	<code class="computeroutput1">-lname</code> where name is the filename of the
	library without the prefix
	<code class="computeroutput1">lib</code>.  We also provide an
	extra search directory for libraries, namely the current
	directory (<code class="computeroutput1">-L .</code>), since by default the
	current directory is not searched for libraries.</p><p class="releaseinfo">The final result is a single executable with our new
	library included.</p></section><section id="libraries_s1_s2"><header class="calibre8"><h4 class="calibre21"><span class="first-last">5<span class="first-last">.</span>1<span class="first-last">.</span>2<span class="first-last"> </span></span>Static Linking Drawbacks</h4></header><p class="releaseinfo">Static linking is very straight forward, but has a number
      of drawbacks.</p><p class="releaseinfo">There are two main disadvantages; firstly if the library
        code is updated (to fix a bug, say) you have to recompile your
        program into a new executable and secondly, every program in
        the system that uses that library contains a copy in its
        executable.  This is very inefficient (and a pain if you find
        a bug and have to recompile, as per point one).</p><p class="releaseinfo">For example, the C library
      (<span>glibc</span>) is included in all programs,
      and provides all the common functions such as
      <code class="computeroutput1">printf</code>.</p></section></section><section id="libraries_s2"><header class="calibre8"><h3 class="calibre2"><span class="first-last">5<span class="first-last">.</span>2<span class="first-last"> </span></span>Shared Libraries</h3></header><p class="releaseinfo">Shared libraries are an elegant way around the problems
      posed by a static library.  A shared library is a library that
      is loaded dynamically at runtime for each application that
      requires it.</p><p class="releaseinfo">The application simply leaves pointers that it will
      require a certain library, and when the function call is made
      the library is loaded into memory and executed.  If the library
      is already loaded for another application, the code can be
      shared between the two, saving considerable resources with
      commonly used libraries.</p><p class="releaseinfo">This process, called dynamic linking, is one of the more
      intricate parts of a modern operating system.  As such, we
      dedicate the next chapter to investigating the dynamic linking
      process.</p></section></section></div></main>

<main class="calibre3">
<div id="chapter07" class="author">
<section id="elf-sections-others"><header class="calibre8"><h2 class="calibre7" id="calibre_pb_61"><span class="first-last">6<span class="first-last"> </span></span>Extending ELF concepts</h2></header><section id="elf_debugging"><header class="calibre8"><h3 class="calibre2"><span class="first-last">6<span class="first-last">.</span>1<span class="first-last"> </span></span>Debugging</h3></header><p class="releaseinfo">Traditionally the primary method of post mortem debugging
      is referred to as the <em class="calibre5">core dump</em>.  The term
      <em class="calibre5">core</em> comes from the original physical
      characteristics of magnetic core memory, which uses the
      orientation of small magnetic rings to store state.
      </p><p class="releaseinfo">Thus a core dump is simply a complete snapshot of the
      program as it was running at a particular time.  A
      <em class="calibre5">debugger</em> can then be used to examine this
      dump and reconstruct the program state.  <a href="#coredump_gdb" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>6<span class="sep">.</span>1<span class="sep">.</span>1, </span><span>Example of creating a core dump and using it with <span>gdb</span></span></span></a> shows a sample program that writes to a
      random memory location in order to force a crash.  At this point
      the processes will be halted and a dump of the current state is
      recorded.</p><div id="coredump_gdb" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="25"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ cat coredump.c</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int main(void) {</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">	char *foo = (char*)0x12345;</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">	*foo = 'a';</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">	return 0;</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gcc -Wall -g -o coredump coredump.c</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ ./coredump</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Segmentation fault (core dumped)</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ file ./core</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">./core: ELF 32-bit LSB core file Intel 80386, version 1 (SYSV), SVR4-style, from './coredump'</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gdb ./coredump</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">...</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">(gdb) core core</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">[New LWP 31614]</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Core was generated by `./coredump'.</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Program terminated with signal 11, Segmentation fault.</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#0  0x080483c4 in main () at coredump.c:3</code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">3		*foo = 'a';</code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">(gdb)</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>6<span>.</span>1<span>.</span>1<span> </span></span>Example of creating a core dump and using it with <span>gdb</span></div></header></div><p class="releaseinfo">Thus a core-dump is just another ELF file with a range of
      sections understood to the debugger to represent parts of the
      running program.</p><section id="elf_debugging_s1"><header class="calibre8"><h4 class="calibre21"><span class="first-last">6<span class="first-last">.</span>1<span class="first-last">.</span>1<span class="first-last"> </span></span>Symbols and Debugging Information</h4></header><p class="releaseinfo">As <a href="#coredump_gdb" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>6<span class="sep">.</span>1<span class="sep">.</span>1, </span><span>Example of creating a core dump and using it with <span>gdb</span></span></span></a> shows, the debugger
        <span>gdb</span> requires the original
        executable and the core dump to reconstruct the environment
        for the debugging session.  Note that the original executable
        was built with the <code class="computeroutput1">-g</code> flag,
        which instructs the compiler to include all
        <em class="calibre5">debugging information</em>.  This extra
        debugging information is kept in special sections of the ELF
        file.  It describes in detail things like what register values
        currently hold which variables used in the code, size of
        variables, length of arrays, etc.  It is generally in the
        standard <em class="calibre5">DWARF</em> format (a pun on the
        almost-synonym ELF).
        </p><p class="releaseinfo">Including debugging information can make executable
        files and libraries very large; although this data is not
        required resident in memory for actually running it can still
        take up considerable disk space.  Thus the usual process is to
        <em class="calibre5">strip</em> this information from the ELF file.
        While it is possible to arrange for shipping of both stripped
        and unstripped files, most all current binary distribution
        methods provide the debugging information in separate files.
        The <span>objcopy</span> tool can be used to
        extract the debugging information
        (<code class="computeroutput1">--only-keep-debug</code>) and then
        add a link in the original executable to this stripped
        information
        (<code class="computeroutput1">--add-gnu-debuglink</code>).  After
        this is done, a special section called
        <code class="computeroutput1">.gnu_debuglink</code> will be
        present in the original executable, which contains a hash so
        that when a debugging sessions starts the debugger can be sure
        it associates the right debugging information with the right
        executable.</p><div id="strip_debug" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="10"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gcc -g -shared -o libtest.so libtest.c</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objcopy --only-keep-debug libtest.so libtest.debug</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objcopy --add-gnu-debuglink=libtest.debug libtest.so</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump -s -j .gnu_debuglink libtest.so</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">libtest.so:     file format elf32-i386</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Contents of section .gnu_debuglink:</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0000 6c696274 6573742e 64656275 67000000  libtest.debug...</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0010 52a7fd0a                             R... </code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>6<span>.</span>1<span>.</span>1<span>.</span>1<span> </span></span>Example of stripping debugging information into
            separate files using
            <span>objcopy</span></div></header></div><p class="releaseinfo">Symbols take up much less space, but are also targets
        for removal from final output.  Once the individual object
        files of an executable are linked into the single final image
        there is generally no need for most symbols to remain.  As
        discussed in <a href="csbu-print_split_050.html#symbols_and_relocations" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>3<span class="sep">.</span>2, </span><span>Symbols and Relocations</span></span></a> symbols
        are required to fix up relocation entries, but once this is
        done the symbols are not strictly necessary for running the
        final program.  On Linux the GNU toolchain
        <span>strip</span> program provides options to
        remove symbols.  Note that some symbols are required to be
        resolved at run-time (for <em class="calibre5">dynamic
        linking</em>, the focus of <a href="csbu-print_split_055.html#chapter08" class="xref pcalibre"><span><span>Chapter<span class="sep"> </span></span><span>9, </span><span>Dynamic Linking</span></span></a>)
        but these are put in separate <em class="calibre5">dynamic</em>
        symbol tables so they will not be removed and render the final
        output useless.</p></section><section id="elf_debugging_s2"><header class="calibre8"><h4 class="calibre21"><span class="first-last">6<span class="first-last">.</span>1<span class="first-last">.</span>2<span class="first-last"> </span></span>Inside coredumps</h4></header><p class="releaseinfo">A coredump is really just another ELF file; this
        illustrates the flexibility of ELF as a binary format.</p><div id="coredump_internal" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="104"><pre class="language-c"><span class="line" db-line="1"><span class="ln">  1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ readelf --all ./core</code></span></span>
<span class="line" db-line="2"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">ELF Header:</code></span></span>
<span class="line" db-line="3"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00 </code></span></span>
<span class="line" db-line="4"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Class:                             ELF32</code></span></span>
<span class="line" db-line="5"><span class="ln">  5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Data:                              2's complement, little endian</code></span></span>
<span class="line" db-line="6"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Version:                           1 (current)</code></span></span>
<span class="line" db-line="7"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  OS/ABI:                            UNIX - System V</code></span></span>
<span class="line" db-line="8"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  ABI Version:                       0</code></span></span>
<span class="line" db-line="9"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Type:                              CORE (Core file)</code></span></span>
<span class="line" db-line="10"><span class="ln"> 10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Machine:                           Intel 80386</code></span></span>
<span class="line" db-line="11"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Version:                           0x1</code></span></span>
<span class="line" db-line="12"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Entry point address:               0x0</code></span></span>
<span class="line" db-line="13"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Start of program headers:          52 (bytes into file)</code></span></span>
<span class="line" db-line="14"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Start of section headers:          0 (bytes into file)</code></span></span>
<span class="line" db-line="15"><span class="ln"> 15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Flags:                             0x0</code></span></span>
<span class="line" db-line="16"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Size of this header:               52 (bytes)</code></span></span>
<span class="line" db-line="17"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Size of program headers:           32 (bytes)</code></span></span>
<span class="line" db-line="18"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Number of program headers:         15</code></span></span>
<span class="line" db-line="19"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Size of section headers:           0 (bytes)</code></span></span>
<span class="line" db-line="20"><span class="ln"> 20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Number of section headers:         0</code></span></span>
<span class="line" db-line="21"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Section header string table index: 0</code></span></span>
<span class="line" db-line="22"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="23"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There are no sections in this file.</code></span></span>
<span class="line" db-line="24"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="25"><span class="ln"> 25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There are no sections to group in this file.</code></span></span>
<span class="line" db-line="26"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="27"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Program Headers:</code></span></span>
<span class="line" db-line="28"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</code></span></span>
<span class="line" db-line="29"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  NOTE           0x000214 0x00000000 0x00000000 0x0022c 0x00000     0</code></span></span>
<span class="line" db-line="30"><span class="ln"> 30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x001000 0x08048000 0x00000000 0x01000 0x01000 R E 0x1000</code></span></span>
<span class="line" db-line="31"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x002000 0x08049000 0x00000000 0x01000 0x01000 RW  0x1000</code></span></span>
<span class="line" db-line="32"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x003000 0x489fc000 0x00000000 0x01000 0x1b000 R E 0x1000</code></span></span>
<span class="line" db-line="33"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x004000 0x48a17000 0x00000000 0x01000 0x01000 R   0x1000</code></span></span>
<span class="line" db-line="34"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x005000 0x48a18000 0x00000000 0x01000 0x01000 RW  0x1000</code></span></span>
<span class="line" db-line="35"><span class="ln"> 35 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x006000 0x48a1f000 0x00000000 0x01000 0x153000 R E 0x1000</code></span></span>
<span class="line" db-line="36"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x007000 0x48b72000 0x00000000 0x00000 0x01000     0x1000</code></span></span>
<span class="line" db-line="37"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x007000 0x48b73000 0x00000000 0x02000 0x02000 R   0x1000</code></span></span>
<span class="line" db-line="38"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x009000 0x48b75000 0x00000000 0x01000 0x01000 RW  0x1000</code></span></span>
<span class="line" db-line="39"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x00a000 0x48b76000 0x00000000 0x03000 0x03000 RW  0x1000</code></span></span>
<span class="line" db-line="40"><span class="ln"> 40 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x00d000 0xb771c000 0x00000000 0x01000 0x01000 RW  0x1000</code></span></span>
<span class="line" db-line="41"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x00e000 0xb774d000 0x00000000 0x02000 0x02000 RW  0x1000</code></span></span>
<span class="line" db-line="42"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x010000 0xb774f000 0x00000000 0x01000 0x01000 R E 0x1000</code></span></span>
<span class="line" db-line="43"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LOAD           0x011000 0xbfeac000 0x00000000 0x22000 0x22000 RW  0x1000</code></span></span>
<span class="line" db-line="44"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="45"><span class="ln"> 45 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There is no dynamic section in this file.</code></span></span>
<span class="line" db-line="46"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="47"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There are no relocations in this file.</code></span></span>
<span class="line" db-line="48"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="49"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There are no unwind sections in this file.</code></span></span>
<span class="line" db-line="50"><span class="ln"> 50 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="51"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">No version information found in this file.</code></span></span>
<span class="line" db-line="52"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="53"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Notes at offset 0x00000214 with length 0x0000022c:</code></span></span>
<span class="line" db-line="54"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Owner                 Data size	Description</code></span></span>
<span class="line" db-line="55"><span class="ln"> 55 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  CORE                 0x00000090	NT_PRSTATUS (prstatus structure)</code></span></span>
<span class="line" db-line="56"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  CORE                 0x0000007c	NT_PRPSINFO (prpsinfo structure)</code></span></span>
<span class="line" db-line="57"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  CORE                 0x000000a0	NT_AUXV (auxiliary vector)</code></span></span>
<span class="line" db-line="58"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LINUX                0x00000030	Unknown note type: (0x00000200)</code></span></span>
<span class="line" db-line="59"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="60"><span class="ln"> 60 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ eu-readelf -n ./core</code></span></span>
<span class="line" db-line="61"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="62"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Note segment of 556 bytes at offset 0x214:</code></span></span>
<span class="line" db-line="63"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Owner          Data size  Type</code></span></span>
<span class="line" db-line="64"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  CORE                 144  PRSTATUS</code></span></span>
<span class="line" db-line="65"><span class="ln"> 65 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    info.si_signo: 11, info.si_code: 0, info.si_errno: 0, cursig: 11</code></span></span>
<span class="line" db-line="66"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    sigpend: &lt;&gt;</code></span></span>
<span class="line" db-line="67"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    sighold: &lt;&gt;</code></span></span>
<span class="line" db-line="68"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    pid: 31614, ppid: 31544, pgrp: 31614, sid: 31544</code></span></span>
<span class="line" db-line="69"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    utime: 0.000000, stime: 0.000000, cutime: 0.000000, cstime: 0.000000</code></span></span>
<span class="line" db-line="70"><span class="ln"> 70 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    orig_eax: -1, fpvalid: 0</code></span></span>
<span class="line" db-line="71"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    ebx:     1219973108  ecx:     1243440144  edx:              1</code></span></span>
<span class="line" db-line="72"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    esi:              0  edi:              0  ebp:     0xbfecb828</code></span></span>
<span class="line" db-line="73"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    eax:          74565  eip:     0x080483c4  eflags:  0x00010286</code></span></span>
<span class="line" db-line="74"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    esp:     0xbfecb818</code></span></span>
<span class="line" db-line="75"><span class="ln"> 75 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    ds: 0x007b  es: 0x007b  fs: 0x0000  gs: 0x0033  cs: 0x0073  ss: 0x007b</code></span></span>
<span class="line" db-line="76"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  CORE                 124  PRPSINFO</code></span></span>
<span class="line" db-line="77"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    state: 0, sname: R, zomb: 0, nice: 0, flag: 0x00400400</code></span></span>
<span class="line" db-line="78"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    uid: 1000, gid: 1000, pid: 31614, ppid: 31544, pgrp: 31614, sid: 31544</code></span></span>
<span class="line" db-line="79"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    fname: coredump, psargs: ./coredump </code></span></span>
<span class="line" db-line="80"><span class="ln"> 80 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  CORE                 160  AUXV</code></span></span>
<span class="line" db-line="81"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    SYSINFO: 0xb774f414</code></span></span>
<span class="line" db-line="82"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    SYSINFO_EHDR: 0xb774f000</code></span></span>
<span class="line" db-line="83"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    HWCAP: 0xafe8fbff  &lt;fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov clflush dts acpi mmx fxsr sse sse2 ss tm pbe&gt;</code></span></span>
<span class="line" db-line="84"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    PAGESZ: 4096</code></span></span>
<span class="line" db-line="85"><span class="ln"> 85 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    CLKTCK: 100</code></span></span>
<span class="line" db-line="86"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    PHDR: 0x8048034</code></span></span>
<span class="line" db-line="87"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    PHENT: 32</code></span></span>
<span class="line" db-line="88"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    PHNUM: 8</code></span></span>
<span class="line" db-line="89"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    BASE: 0</code></span></span>
<span class="line" db-line="90"><span class="ln"> 90 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    FLAGS: 0</code></span></span>
<span class="line" db-line="91"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    ENTRY: 0x8048300</code></span></span>
<span class="line" db-line="92"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    UID: 1000</code></span></span>
<span class="line" db-line="93"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    EUID: 1000</code></span></span>
<span class="line" db-line="94"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    GID: 1000</code></span></span>
<span class="line" db-line="95"><span class="ln"> 95 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    EGID: 1000</code></span></span>
<span class="line" db-line="96"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    SECURE: 0</code></span></span>
<span class="line" db-line="97"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    RANDOM: 0xbfecba1b</code></span></span>
<span class="line" db-line="98"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    EXECFN: 0xbfecdff1</code></span></span>
<span class="line" db-line="99"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    PLATFORM: 0xbfecba2b</code></span></span>
<span class="line" db-line="100"><span class="ln">100 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    NULL</code></span></span>
<span class="line" db-line="101"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  LINUX                 48  386_TLS</code></span></span>
<span class="line" db-line="102"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    index: 6, base: 0xb771c8d0, limit: 0x000fffff, flags: 0x00000051</code></span></span>
<span class="line" db-line="103"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    index: 7, base: 0x00000000, limit: 0x00000000, flags: 0x00000028</code></span></span>
<span class="line" db-line="104"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    index: 8, base: 0x00000000, limit: 0x00000000, flags: 0x00000028</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>6<span>.</span>1<span>.</span>2<span>.</span>1<span> </span></span>Example of using <span>readelf</span>
            and <span>eu-readelf</span> to examine a
            coredump.</div></header></div><p class="releaseinfo">In <a href="#coredump_internal" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>6<span class="sep">.</span>1<span class="sep">.</span>2<span class="sep">.</span>1, </span><span>Example of using <span>readelf</span>
            and <span>eu-readelf</span> to examine a
            coredump.</span></span></a> we can see an
        examination of the core file produced by <a href="#coredump_gdb" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>6<span class="sep">.</span>1<span class="sep">.</span>1, </span><span>Example of creating a core dump and using it with <span>gdb</span></span></span></a> using firstly the
        <span>readelf</span> tool.  There are no
        sections, relocations or other extraneous information in the
        file that may be required for loading an executable or
        library; it simply consists of a series of program headers
        describing <code class="computeroutput1">LOAD</code> segments.
        These segments are raw data dumps, created by the kernel, of
        the current memory allocations.
	</p><p class="releaseinfo">The other component of the core dump is the
        <code class="computeroutput1">NOTE</code> sections which contain
        data necessary for debugging but not necessarily captured in
        straight snapshot of the memory allocations.  The
        <span>eu-readelf</span> program used in the
        second part of the figure provides a more complete view of the
        data by decoding it.</p><p class="releaseinfo">The <code class="computeroutput1">PRSTATUS</code> note gives
        a range of interesting information about the process as it was
        running; for example we can see from
        <code class="computeroutput1">cursig</code> that the program
        received a signal 11, or segmentation fault, as we would
        expect.  Along with process number information, it also
        includes a dump of all the current registers.  Given the
        register values, the debugger can reconstruct the stack state
        and hence provide a <em class="calibre5">backtrace</em>; combined
        with the symbol and debugging information from the original
        binary the debugger can show exactly how you reached the
        current point of execution.</p><p class="releaseinfo">Another interesting output is the current
        <em class="calibre5">auxiliary vector</em>
        (<code class="computeroutput1">AUXV</code>), discussed in <a href="csbu-print_split_055.html#auxv" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>8<span class="sep">.</span>1, </span><span>Kernel communication to programs</span></span></a>.  The
        <code class="computeroutput1">386_TLS</code> describes
        <em class="calibre5">global descriptor table</em> entries used for
        the x86 implementation of <em class="calibre5">thread-local
        storage</em> (see <a href="csbu-print_split_019.html#fast_system_calls" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>4<span class="sep">.</span>1<span class="sep">.</span>1<span class="sep">.</span>3, </span><span>Fast System Calls</span></span></a>
        for more information on use of segmentation, and <a href="csbu-print_split_024.html#threads" class="xref pcalibre"><span><span>Section<span class="sep"> </span></span><span>4<span class="sep">.</span>3<span class="sep">.</span>1<span class="sep">.</span>1, </span><span>Threads</span></span></a> for information on
        threads<span id="elf_debugging_s2_para5_footnote1-fnote">For a multi-threaded application, there
        would be duplicate entries for each thread running.  The
        debugger will understand this, and it is how
        <span>gdb</span> implements the
        <code class="computeroutput1">thread</code> command to show and
        switch between threads.</span>).
	  </p><p class="releaseinfo">The kernel creates the core dump file within the bounds
        of the current <code class="computeroutput1">ulimit</code>
        settings — since a program using a lot of memory could
        result in a very large dump, potentially filling up disk and
        making problems even worse, generally the
        <code class="computeroutput1">ulimit</code> is set low or even at
        zero, since most non-developers have little use for a core
        dump file.  However the core dump remains the single most
        useful way to debug an unexpected situation in a postmortem
        fashion.</p></section></section><section id="extra_sections"><header class="calibre8"><h3 class="calibre2"><span class="first-last">6<span class="first-last">.</span>2<span class="first-last"> </span></span>Custom sections</h3></header><p class="releaseinfo">For the most part, organisation of code, data and symbols
      is something a programmer can leave up the toolchain defaults.
      However, there are times when it makes sense to extend or
      customise sections and their contents.  One common example of
      this is with Linux kernel <em class="calibre5">modules</em> which are
      used to dynamically load drivers and other features into the
      running kernel.  Because these modules are not portable, in so
      much as they only work with one fixed kernel build version, the
      interface between modules and the kernel can be flexible and is
      not bound to particular standards.  This means the methods of
      storing things like license information, authorship,
      dependencies and paramaters for the moudule can be uniquely and
      wholly defined by the kernel.</p><p class="releaseinfo">The <code class="computeroutput1">modinfo</code> tool can
      inspect this information within a module and present it to the
      user.  Below we use the example of the <code class="computeroutput1">FUSE</code>
      Linux kernel module, which allows user-space libraries to
      provide file-system implementations to the kernel.</p><div id="modinfo" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="51"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ cd /lib/modules/$(uname -r)</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ sudo modinfo ./kernel/fs/fuse/fuse.ko </code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">filename:       /lib/modules/3.2.0-4-amd64/./kernel/fs/fuse/fuse.ko</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">alias:          devname:fuse</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">alias:          char-major-10-229</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">license:        GPL</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">description:    Filesystem in Userspace</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">author:         Miklos Szeredi &lt;miklos@szeredi.hu&gt;</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">depends:        </code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">intree:         Y</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">vermagic:       3.2.0-4-amd64 SMP mod_unload modversions </code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">parm:           max_user_bgreq:Global limit for the maximum number of backgrounded requests an unprivileged user can set (uint)</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">parm:           max_user_congthresh:Global limit for the maximum congestion threshold an unprivileged user can set (uint)</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump -s -j .modinfo ./kernel/fs/fuse/fuse.ko </code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">./kernel/fs/fuse/fuse.ko:     file format elf64-x86-64</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Contents of section .modinfo:</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0000 616c6961 733d6465 766e616d 653a6675  alias=devname:fu</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0010 73650061 6c696173 3d636861 722d6d61  se.alias=char-ma</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0020 6a6f722d 31302d32 32390070 61726d3d  jor-10-229.parm=</code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0030 6d61785f 75736572 5f636f6e 67746872  max_user_congthr</code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0040 6573683a 476c6f62 616c206c 696d6974  esh:Global limit</code></span></span>
<span class="line" db-line="26"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0050 20666f72 20746865 206d6178 696d756d   for the maximum</code></span></span>
<span class="line" db-line="27"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0060 20636f6e 67657374 696f6e20 74687265   congestion thre</code></span></span>
<span class="line" db-line="28"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0070 73686f6c 6420616e 20756e70 72697669  shold an unprivi</code></span></span>
<span class="line" db-line="29"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0080 6c656765 64207573 65722063 616e2073  leged user can s</code></span></span>
<span class="line" db-line="30"><span class="ln">30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0090 65740070 61726d74 7970653d 6d61785f  et.parmtype=max_</code></span></span>
<span class="line" db-line="31"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 00a0 75736572 5f636f6e 67746872 6573683a  user_congthresh:</code></span></span>
<span class="line" db-line="32"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 00b0 75696e74 00706172 6d3d6d61 785f7573  uint.parm=max_us</code></span></span>
<span class="line" db-line="33"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 00c0 65725f62 67726571 3a476c6f 62616c20  er_bgreq:Global </code></span></span>
<span class="line" db-line="34"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 00d0 6c696d69 7420666f 72207468 65206d61  limit for the ma</code></span></span>
<span class="line" db-line="35"><span class="ln">35 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 00e0 78696d75 6d206e75 6d626572 206f6620  ximum number of </code></span></span>
<span class="line" db-line="36"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 00f0 6261636b 67726f75 6e646564 20726571  backgrounded req</code></span></span>
<span class="line" db-line="37"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0100 75657374 7320616e 20756e70 72697669  uests an unprivi</code></span></span>
<span class="line" db-line="38"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0110 6c656765 64207573 65722063 616e2073  leged user can s</code></span></span>
<span class="line" db-line="39"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0120 65740070 61726d74 7970653d 6d61785f  et.parmtype=max_</code></span></span>
<span class="line" db-line="40"><span class="ln">40 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0130 75736572 5f626772 65713a75 696e7400  user_bgreq:uint.</code></span></span>
<span class="line" db-line="41"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0140 6c696365 6e73653d 47504c00 64657363  license=GPL.desc</code></span></span>
<span class="line" db-line="42"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0150 72697074 696f6e3d 46696c65 73797374  ription=Filesyst</code></span></span>
<span class="line" db-line="43"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0160 656d2069 6e205573 65727370 61636500  em in Userspace.</code></span></span>
<span class="line" db-line="44"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0170 61757468 6f723d4d 696b6c6f 7320537a  author=Miklos Sz</code></span></span>
<span class="line" db-line="45"><span class="ln">45 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0180 65726564 69203c6d 696b6c6f 7340737a  eredi &lt;miklos@sz</code></span></span>
<span class="line" db-line="46"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 0190 65726564 692e6875 3e000000 00000000  eredi.hu&gt;.......</code></span></span>
<span class="line" db-line="47"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 01a0 64657065 6e64733d 00696e74 7265653d  depends=.intree=</code></span></span>
<span class="line" db-line="48"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 01b0 59007665 726d6167 69633d33 2e322e30  Y.vermagic=3.2.0</code></span></span>
<span class="line" db-line="49"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 01c0 2d342d61 6d643634 20534d50 206d6f64  -4-amd64 SMP mod</code></span></span>
<span class="line" db-line="50"><span class="ln">50 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 01d0 5f756e6c 6f616420 6d6f6476 65727369  _unload modversi</code></span></span>
<span class="line" db-line="51"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 01e0 6f6e7320 00                          ons .           </code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>6<span>.</span>2<span>.</span>1<span> </span></span>Example of <code class="computeroutput1">modinfo</code>
	  output</div></header></div><p class="releaseinfo">As you can see above,
      <code class="computeroutput1">modinfo</code> is parsing the
      <code class="computeroutput1">.modinfo</code> section embedded
      within the module file to present the details of the module.
      <a href="#modinfo_sections" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>6<span class="sep">.</span>2<span class="sep">.</span>2, </span><span>Putting module info into sections</span></span></a> shows how one field, the
      "author" is put into the module.  The code mostly comes from
      <code class="computeroutput1">include/linux/module.h</code>.
      </p><div id="modinfo_sections" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="36"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/*</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> * Start at the bottom, and work your way up!</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> */</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/* Indirect macros required for expanded argument pasting, eg. __LINE__. */</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#define ___PASTE(a,b) a##b</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#define __PASTE(a,b) ___PASTE(a,b)</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#define __UNIQUE_ID(prefix) __PASTE(__PASTE(__UNIQUE_ID_, prefix), __COUNTER__)</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/* Indirect stringification.  Doing two levels allows the parameter to be a</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> * macro itself.  For example, compile with -DFOO=bar, __stringify(FOO)</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> * converts to "bar".</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> */</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#define __stringify_1(x...)     #x</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#define __stringify(x...)       __stringify_1(x)</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#define __MODULE_INFO(tag, name, info)                                    \</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">static const char __UNIQUE_ID(name)[]                                     \</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  __used __attribute__((section(".modinfo"), unused, aligned(1)))         \</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  = __stringify(tag) "=" info</code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/* Generic info of form tag = "info" */</code></span></span>
<span class="line" db-line="26"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#define MODULE_INFO(tag, info) __MODULE_INFO(tag, tag, info)</code></span></span>
<span class="line" db-line="27"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="28"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/*</code></span></span>
<span class="line" db-line="29"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> * Author(s), use "Name &lt;email&gt;" or just "Name", for multiple</code></span></span>
<span class="line" db-line="30"><span class="ln">30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> * authors use multiple MODULE_AUTHOR() statements/lines.</code></span></span>
<span class="line" db-line="31"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> */</code></span></span>
<span class="line" db-line="32"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#define MODULE_AUTHOR(_author) MODULE_INFO(author, _author)</code></span></span>
<span class="line" db-line="33"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="34"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">/* ---- */</code></span></span>
<span class="line" db-line="35"><span class="ln">35 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="36"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">MODULE_AUTHOR("Your Name &lt;your@name.com&gt;");</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>6<span>.</span>2<span>.</span>2<span> </span></span>Putting module info into sections</div></header></div><p class="releaseinfo">At first, this looks like a macro nightmare, but it can be
      unravelled step by step.  Starting at the bottom, we see that
      <code class="computeroutput1">MODULE_AUTHOR</code> is a wrapper
      around the more generic
      <code class="computeroutput1">__MODULE_INFO</code> macro, which is
      where most of the magic happens.  There, we can see that we are
      building up a <code class="computeroutput1">static const char
      []</code> variable to hold the string
      <code class="computeroutput1">"author=Your Name
      &lt;your@name.com&gt;"</code>.  The interesting thing
      to note is that the variable has an extra parameter
      <code class="computeroutput1">__attribute__((section(".modinfo")))</code>
      which is telling the compiler to not put this in the
      <code class="computeroutput1">data</code> section with all the other
      variables, but to stash it in its own ELF section called
      <code class="computeroutput1">.modinfo</code>.  The other parameters
      stop the variable being optimised away because it looks unused
      and to ensure we pack the variables in next to each other by
      specifying the alignment.</p><p class="releaseinfo">There is extensive use of
      <em class="calibre5">stringification</em> macros, which are rather
      arcane tricks used within the C pre-processor to ensure that
      strings and definitions can live together.  The only other
      trick is the use of the
      <code class="computeroutput1">__COUNTER__</code> special define
      provided by <code class="computeroutput1">gcc</code>, which provides a unique,
      incrementing value each time it is called; this allows
      multiple <code class="computeroutput1">MODULE_AUTHOR</code> calls
      to in the one file and not end up with the same variable
      name.</p><p class="releaseinfo">We can inspect the symbols placed in the final
      module to see the end result:</p><div id="module-symbols" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="18"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump --syms ./fuse.ko | grep modinfo</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">0000000000000000 l    d  .modinfo	0000000000000000 .modinfo</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">0000000000000000 l     O .modinfo	0000000000000013 __UNIQUE_ID_alias1</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">0000000000000013 l     O .modinfo	0000000000000018 __UNIQUE_ID_alias0</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">000000000000002b l     O .modinfo	0000000000000011 __UNIQUE_ID_alias8</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">000000000000003c l     O .modinfo	000000000000000e __UNIQUE_ID_alias7</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">000000000000004a l     O .modinfo	0000000000000068 __UNIQUE_ID_max_user_congthresh6</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">00000000000000b2 l     O .modinfo	0000000000000022 __UNIQUE_ID_max_user_congthreshtype5</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">00000000000000d4 l     O .modinfo	000000000000006e __UNIQUE_ID_max_user_bgreq4</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">0000000000000142 l     O .modinfo	000000000000001d __UNIQUE_ID_max_user_bgreqtype3</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">000000000000015f l     O .modinfo	000000000000000c __UNIQUE_ID_license2</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">000000000000016b l     O .modinfo	0000000000000024 __UNIQUE_ID_description1</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">000000000000018f l     O .modinfo	000000000000002a __UNIQUE_ID_author0</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">00000000000001b9 l     O .modinfo	0000000000000011 __UNIQUE_ID_alias0</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">00000000000001d0 l     O .modinfo	0000000000000009 __module_depends</code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">00000000000001d9 l     O .modinfo	0000000000000009 __UNIQUE_ID_intree1</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">00000000000001e2 l     O .modinfo	000000000000002f __UNIQUE_ID_vermagic0</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>6<span>.</span>2<span>.</span>3<span> </span></span>Module symbols in
          <code class="computeroutput1">.modinfo</code> sections</div></header></div></section><section id="elf-sections-others_s3"><header class="calibre8"><h3 class="calibre2"><span class="first-last">6<span class="first-last">.</span>3<span class="first-last"> </span></span>Linker Scripts</h3></header><p class="releaseinfo">
         In <a href="csbu-print_split_050.html#section" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>3<span class="sep">.</span>3<span class="sep">.</span>2<span class="sep">.</span>2, </span><span>Sections </span></span></a> we described how sections make
         up segments in the final output.  It is the job of the linker
         to build these sections into segments; to achieve this it
         uses a <em class="calibre5">linker script</em> which describes
         where segments start, what sections go into them and various
         other parameters.  </p><p class="releaseinfo"><a href="#linker-script" class="xref pcalibre"><span><span>Example<span class="sep"> </span></span><span>6<span class="sep">.</span>3<span class="sep">.</span>1, </span><span>The default linker script</span></span></a> shows an extract of the
       default linker script, which the linker will show when given
       its verbose flag via specifying
       <code class="computeroutput1">-Wl,--verbose</code> to
       <span>gcc</span>.  The default script is built-in
       to the linker and is based on the standard API definitions to
       create working user-space programs for the building
       platform.</p><div id="linker-script" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="31"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gcc -Wl,--verbose -o test test.c</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">GNU ld (GNU Binutils for Debian) 2.26</code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">...</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">using internal linker script:</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">==================================================</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">OUTPUT_FORMAT("elf64-x86-64", "elf64-x86-64",</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">	      "elf64-x86-64")</code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">OUTPUT_ARCH(i386:x86-64)</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">ENTRY(_start)</code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">SEARCH_DIR("=/usr/local/lib/x86_64-linux-gnu"); ...</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">SECTIONS</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">{</code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  /* Read-only sections, merged into text segment: */</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  PROVIDE (__executable_start = SEGMENT_START("text-segment", 0x400000)); . = SEGMENT_START("text-segment", 0x400000) + SIZEOF_HEADERS;</code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .interp         : { *(.interp) }</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .note.gnu.build-id : { *(.note.gnu.build-id) }</code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .hash           : { *(.hash) }</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .gnu.hash       : { *(.gnu.hash) }</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .dynsym         : { *(.dynsym) }</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .dynstr         : { *(.dynstr) }</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .gnu.version    : { *(.gnu.version) }</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .gnu.version_d  : { *(.gnu.version_d) }</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .gnu.version_r  : { *(.gnu.version_r) }</code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .rela.dyn       :</code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    {</code></span></span>
<span class="line" db-line="26"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    ...</code></span></span>
<span class="line" db-line="27"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">    }</code></span></span>
<span class="line" db-line="28"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  PROVIDE (etext = .);</code></span></span>
<span class="line" db-line="29"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .rodata         : { *(.rodata .rodata.* .gnu.linkonce.r.*) }</code></span></span>
<span class="line" db-line="30"><span class="ln">30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  .rodata1        : { *(.rodata1) }</code></span></span>
<span class="line" db-line="31"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">...</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>6<span>.</span>3<span>.</span>1<span> </span></span>The default linker script</div></header></div><p class="releaseinfo">You can roughly see how the linker script specifies
       things like starting locations and what sections to group into
       various segments.  In the same way
       <code class="computeroutput1">-Wl</code> is used to pass the
       <code class="computeroutput1">--verbose</code> to the linker via
       <span>gcc</span>, customised linker scripts can
       be provided by flags.  Regular user-space developers are
       unlikely to need to override the default linker script.
       However, often very customised applications such as kernel
       builds require customised linker scripts.
       </p></section></section></div></main>

<main class="calibre3">
<div id="chapter07" class="author">
<section id="abi"><header class="calibre8"><h2 class="calibre7" id="calibre_pb_62"><span class="first-last">7<span class="first-last"> </span></span>ABIs</h2></header><p class="releaseinfo">An ABI is a term you will hear a lot about when working with
    systems programming.  We have talked extensively about
    <em class="calibre5">API</em>, which are interfaces the programmer sees
    to your code.</p><p class="releaseinfo">ABI's refer to lower level interfaces which the compiler,
    operating system and, to some extent, processor, must agree on to
    communicate together.  Below we introduce a number of concepts
    which are important to understanding ABI considerations.</p><section id="abi_s1"><header class="calibre8"><h3 class="calibre2"><span class="first-last">7<span class="first-last">.</span>1<span class="first-last"> </span></span>Byte Order</h3></header><p class="releaseinfo">Endianess</p></section><section id="abi_s2"><header class="calibre8"><h3 class="calibre2"><span class="first-last">7<span class="first-last">.</span>2<span class="first-last"> </span></span>Calling Conventions</h3></header><section id="abi_s2_s1"><header class="calibre8"><h4 class="calibre21"><span class="first-last">7<span class="first-last">.</span>2<span class="first-last">.</span>1<span class="first-last"> </span></span>Passing parameters</h4></header><p class="releaseinfo">registers or stack?</p></section><section id="abi_s2_s2"><header class="calibre8"><h4 class="calibre21"><span class="first-last">7<span class="first-last">.</span>2<span class="first-last">.</span>2<span class="first-last"> </span></span>Function Descriptors</h4></header><p class="releaseinfo">On many architectures you must call a function through a
	<em class="calibre5">function descriptor</em>, rather than
	directly.</p><p class="releaseinfo">For example, on IA64 a function descriptor consists of
	two components; the address of the function (that being a 64
	bit, or 8 byte value) and the address of the <em class="calibre5">global
	pointer</em> (gp).  The ABI specifies that r1 should
	always contain the gp value for a function.  This means that
	when you call a function, it is the
	<code class="computeroutput1">callees</code> job to save their gp
	value, set r1 to be the new value (from the function
	descriptor) and <code class="computeroutput1">then</code> call the
	function.</p><p class="releaseinfo">This may seem like a strange way to do things, but it
	has very useful practical implications as you will see in the
	next chapter about global offset tables.  On IA64 an
	<code class="computeroutput1">add</code> instruction can only take
	a maximum 22 bit <em class="calibre5">immediate
	value</em><span id="abi_s2_s2_para3_footnote1-fnote">Technically this is because of
	the way IA64 bundles instructions.  Three instructions are put
	into each bundle, and there is only enough room to keep a 22
	bit value to keep the bundle together.</span>.  An
	immediate value is one that is specified directly, rather than
	in a register (e.g. in <code class="computeroutput1">add r1 +
	100</code> 100 is the immediate value).</p><p class="releaseinfo">You might recognise 22 bits as being able to represent
	4194304 bytes, or 4MB.  Thus each function can directly offset
	into an area of memory 4MB big without having to take the
	penalty of loading any values into a register.  If the
	compiler, linker and loader all agree on what the global
	pointer is pointing to (as specified in the ABI) performance
	can be improved by less loading.</p></section></section></section></div></main>

<main class="calibre3">
<div id="chapter07" class="author">
<section id="starting_a_process"><header class="calibre8"><h2 class="calibre7" id="calibre_pb_63"><span class="first-last">8<span class="first-last"> </span></span>Starting a process</h2></header><p class="releaseinfo">We mentioned before that simply saying the program starts
    with the <code class="computeroutput1">main()</code> function is not
    quite true.  Below we examine what happens to a typical dynamically
    linked program when it is loaded and run (statically linked
    programs are similar but different XXX should we go into
    this?).</p><p class="releaseinfo">Firstly, in response to an
    <code class="computeroutput1">exec</code> system call the kernel
    allocates the structures for a new process and reads the ELF file
    specified from disk.</p><p class="releaseinfo">We mentioned that ELF has a program interpreter field,
    <code class="computeroutput1">PT_INTERP</code>, which can be set to
    'interpret' the program.  For dynamically linked applications that
    interpreter is the dynamic linker, namely
    <span>ld.so</span>, which allows some of the linking
    process to be done on the fly before the program starts.</p><p class="releaseinfo">In this case, the kernel <em class="calibre5">also</em> reads in
    the dynamic linker code, and starts the program from the entry
    point address as specified by it.  We examine the role of the
    dynamic linker in depth in the next chapter, but suffice to say it
    does some setup like loading any libraries required by the
    application (as specified in the dynamic section of the binary)
    and then starts execution of the program binary at its entry
    point address (i.e. the <code class="computeroutput1">_init</code>
    function).</p><section id="auxv"><header class="calibre8"><h3 class="calibre2"><span class="first-last">8<span class="first-last">.</span>1<span class="first-last"> </span></span>Kernel communication to programs</h3></header><p class="releaseinfo">The kernel needs to communicate some things to programs
      when they start up; namely the arguments to the program, the
      current environment variables and a special structure called the
      <code class="computeroutput1">Auxiliary Vector</code> or
      <code class="computeroutput1">auxv</code> (you can request the the
      dynamic linker show you some debugging output of the
      <code class="computeroutput1">auxv</code> by specifying the
      environment value
      <code class="computeroutput1">LD_SHOW_AUXV=1</code>).</p><p class="releaseinfo">The arguments and environment at fairly straight forward,
      and the various incarnations of the
      <code class="computeroutput1">exec</code> system call allow you to
      specify these for the program.</p><p class="releaseinfo">The kernel communicates this by putting all the required
      information on the stack for the newly created program to pick
      up.  Thus when the program starts it can use its stack pointer
      to find the all the startup information required.</p><p class="releaseinfo">The auxiliary vector is a special structure that is for
      passing information directly from the kernel to the newly
      running program.  It contains system specific information that
      may be required, such as the default size of a virtual memory
      page on the system or <em class="calibre5">hardware
      capabilities</em>; that is specific features that the
      kernel has identified the underlying hardware has that userspace
      programs can take advantage of.</p><section id="kernel_library"><header class="calibre8"><h4 class="calibre21"><span class="first-last">8<span class="first-last">.</span>1<span class="first-last">.</span>1<span class="first-last"> </span></span>Kernel Library</h4></header><p class="releaseinfo">We mentioned previously that system calls are slow, and
	modern systems have mechanisms to avoid the overheads of
	calling a trap to the processor.</p><p class="releaseinfo">In Linux, this is implemented by a neat trick between
	the dynamic loader and the kernel, all communicated with the
	AUXV structure.  The kernel actually adds a small shared
	library into the address space of every newly created process
	which contains a function that makes system calls for you.
	The beauty of this system is that if the underlying hardware
	supports a fast system call mechanism the kernel (being the
	creator of the library) can use it, otherwise it can use the
	old scheme of generating a trap.  This library is named
	<code class="computeroutput1">linux-gate.so.1</code>, so called
	because it is a <em class="calibre5">gateway</em> to the inner
	workings of the kernel.</p><p class="releaseinfo">When the kernel starts the dynamic linker it adds an
	entry to the auxv called
	<code class="computeroutput1">AT_SYSINFO_EHDR</code>, which is the
	address in memory that the special kernel library lives in.
	When the dynamic linker starts it can look for the
	<code class="computeroutput1">AT_SYSINFO_EHDR</code> pointer, and
	if found load that library for the program.  The program has
	no idea this library exists; this is a private arrangement
	between the dynamic linker and the kernel.</p><p class="releaseinfo">We mentioned that programmers make system calls
	indirectly through calling functions in the system libraries,
	namely <span>libc</span>.
	<span>libc</span> can check to see if the
	special kernel binary is loaded, and if so use the functions
	within that to make system calls.  As we mentioned, if the
	kernel determines the hardware is capable, this will use the
	fast system call method.</p></section></section><section id="startup"><header class="calibre8"><h3 class="calibre2"><span class="first-last">8<span class="first-last">.</span>2<span class="first-last"> </span></span>Starting the program</h3></header><p class="releaseinfo">Once the kernel has loaded the interpreter it passes it to
      the entry point as given in the interpreter file (note will not
      examine how the dynamic linker starts at this stage; see <a href="#chapter08" class="xref pcalibre"><span><span>Chapter<span class="sep"> </span></span><span>9, </span><span>Dynamic Linking</span></span></a> for a full discussion of dynamic
      linking).  The dynamic linker will jump to the entry point
      address as given in the ELF binary.</p><div id="program-startup" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="62"><pre class="language-c"><span class="line" db-line="1"><span class="ln"> 1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ cat test.c</code></span></span>
<span class="line" db-line="2"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="3"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int main(void)</code></span></span>
<span class="line" db-line="4"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">{</code></span></span>
<span class="line" db-line="5"><span class="ln"> 5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">	return 0;</code></span></span>
<span class="line" db-line="6"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
<span class="line" db-line="7"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="8"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gcc -o test test.c</code></span></span>
<span class="line" db-line="9"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="10"><span class="ln">10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ readelf --headers ./test | grep Entry</code></span></span>
<span class="line" db-line="11"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  Entry point address:               0x80482b0</code></span></span>
<span class="line" db-line="12"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="13"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump --disassemble ./test</code></span></span>
<span class="line" db-line="14"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="15"><span class="ln">15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">[...]</code></span></span>
<span class="line" db-line="16"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="17"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13">080482b0 &lt;_start&gt;:</code></span></span>
<span class="line" db-line="18"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482b0:       31 ed                   xor    %ebp,%ebp</code></span></span>
<span class="line" db-line="19"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482b2:       5e                      pop    %esi</code></span></span>
<span class="line" db-line="20"><span class="ln">20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482b3:       89 e1                   mov    %esp,%ecx</code></span></span>
<span class="line" db-line="21"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482b5:       83 e4 f0                and    $0xfffffff0,%esp</code></span></span>
<span class="line" db-line="22"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482b8:       50                      push   %eax</code></span></span>
<span class="line" db-line="23"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482b9:       54                      push   %esp</code></span></span>
<span class="line" db-line="24"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482ba:       52                      push   %edx</code></span></span>
<span class="line" db-line="25"><span class="ln">25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482bb:       68 00 84 04 08          push   $0x8048400</code></span></span>
<span class="line" db-line="26"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482c0:       68 90 83 04 08          push   $0x8048390</code></span></span>
<span class="line" db-line="27"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482c5:       51                      push   %ecx</code></span></span>
<span class="line" db-line="28"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482c6:       56                      push   %esi</code></span></span>
<span class="line" db-line="29"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482c7:       68 68 83 04 08          push   $0x8048368</code></span></span>
<span class="line" db-line="30"><span class="ln">30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482cc:       e8 b3 ff ff ff          call   8048284 &lt;__libc_start_main@plt&gt;</code></span></span>
<span class="line" db-line="31"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482d1:       f4                      hlt</code></span></span>
<span class="line" db-line="32"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482d2:       90                      nop</code></span></span>
<span class="line" db-line="33"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80482d3:       90                      nop</code></span></span>
<span class="line" db-line="34"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="35"><span class="ln">35 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">08048368 &lt;main&gt;:</code></span></span>
<span class="line" db-line="36"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048368:       55                      push   %ebp</code></span></span>
<span class="line" db-line="37"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048369:       89 e5                   mov    %esp,%ebp</code></span></span>
<span class="line" db-line="38"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804836b:       83 ec 08                sub    $0x8,%esp</code></span></span>
<span class="line" db-line="39"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804836e:       83 e4 f0                and    $0xfffffff0,%esp</code></span></span>
<span class="line" db-line="40"><span class="ln">40 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048371:       b8 00 00 00 00          mov    $0x0,%eax</code></span></span>
<span class="line" db-line="41"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048376:       83 c0 0f                add    $0xf,%eax</code></span></span>
<span class="line" db-line="42"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048379:       83 c0 0f                add    $0xf,%eax</code></span></span>
<span class="line" db-line="43"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804837c:       c1 e8 04                shr    $0x4,%eax</code></span></span>
<span class="line" db-line="44"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804837f:       c1 e0 04                shl    $0x4,%eax</code></span></span>
<span class="line" db-line="45"><span class="ln">45 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048382:       29 c4                   sub    %eax,%esp</code></span></span>
<span class="line" db-line="46"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048384:       b8 00 00 00 00          mov    $0x0,%eax</code></span></span>
<span class="line" db-line="47"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048389:       c9                      leave</code></span></span>
<span class="line" db-line="48"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804838a:       c3                      ret</code></span></span>
<span class="line" db-line="49"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804838b:       90                      nop</code></span></span>
<span class="line" db-line="50"><span class="ln">50 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804838c:       90                      nop</code></span></span>
<span class="line" db-line="51"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804838d:       90                      nop</code></span></span>
<span class="line" db-line="52"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804838e:       90                      nop</code></span></span>
<span class="line" db-line="53"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804838f:       90                      nop</code></span></span>
<span class="line" db-line="54"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="55"><span class="ln">55 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">08048390 &lt;__libc_csu_init&gt;:</code></span></span>
<span class="line" db-line="56"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048390:       55                      push   %ebp</code></span></span>
<span class="line" db-line="57"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048391:       89 e5                   mov    %esp,%ebp</code></span></span>
<span class="line" db-line="58"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> [...]</code></span></span>
<span class="line" db-line="59"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="60"><span class="ln">60 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">08048400 &lt;__libc_csu_fini&gt;:</code></span></span>
<span class="line" db-line="61"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048400:       55                      push   %ebp</code></span></span>
<span class="line" db-line="62"><span class="ln">   <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> [...]</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>8<span>.</span>2<span>.</span>1<span> </span></span>Disassembley of program startup</div></header></div><p class="releaseinfo">Above we investigate the very simplest program.  Using
      <span>readelf</span> we can see that the entry
      point is the <code class="computeroutput1">_start</code> function in
      the binary.  At this point we can see in the disassembley some
      values are pushed onto the stack.  The first value,
      <code class="computeroutput1">0x8048400</code> is the
      <code class="computeroutput1">__libc_csu_fini</code> function;
      <code class="computeroutput1">0x8048390</code> is the
      <code class="computeroutput1">__libc_csu_init</code> and then
      finally <code class="computeroutput1">0x8048368</code>, the
      <code class="computeroutput1">main()</code> function.  After this
      the value <code class="computeroutput1">__libc_start_main</code>
      function is called.</p><p class="releaseinfo"><code class="computeroutput1">__libc_start_main</code> is
      defined in the glibc sources
      <code class="computeroutput1">sysdeps/generic/libc-start.c</code>.
      The file function is quite complicated and hidden between a
      large number of defines, as it needs to be portable across the
      very wide number of systems and architectures that glibc can run
      on.  It does a number of specific things related to setting up
      the C library which the average programmer does not need to
      worry about.  The next point where the library calls back into
      the program is to handle <code class="computeroutput1">init</code>
      code.</p><p class="releaseinfo"><code class="computeroutput1">init</code> and
      <code class="computeroutput1">fini</code> are two special concepts
      that call parts of code in shared libraries that may need to be
      called before the library starts or if the library is unloaded
      respectively.  You can see how this might be useful for library
      programmers to setup variables when the library is started, or
      to clean up at the end.  Originally the functions
      <code class="computeroutput1">_init</code> and
      <code class="computeroutput1">_fini</code> were looked for in the
      library; however this became somewhat limiting as everything was
      required to be in these functions.  Below we will examine just
      how the
      <code class="computeroutput1">init</code>/<code class="computeroutput1">fini</code>
      process works.</p><p class="releaseinfo">At this stage we can see that the
      <code class="computeroutput1">__libc_start_main</code> function will
      receive quite a few input paramaters on the stack.  Firstly it
      will have access to the program arguments, environment variables
      and auxiliary vector from the kernel.  Then the initalization
      function will have pushed onto the stack addresses for functions
      to handle <code class="computeroutput1">init</code>,
      <code class="computeroutput1">fini</code>, and finally the address
      of the main function itself.</p><p class="releaseinfo">We need some way to indicate in the source code that a
      function should be called by
      <code class="computeroutput1">init</code> or
      <code class="computeroutput1">fini</code>.  With
      <span>gcc</span> we use
      <em class="calibre5">attributes</em> to label two functions as
      <em class="calibre5">constructors</em> and
      <em class="calibre5">destructors</em> in our main program.  These
      terms are more commonly used with object oriented languages to
      describe object life cycles.</p><div id="constructor-destructor" class="figure"><div class="pre-wrap" db-startinglinenumber="1" db-numberoflines="117"><pre class="language-c"><span class="line" db-line="1"><span class="ln">  1 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ cat test.c</code></span></span>
<span class="line" db-line="2"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">#include &lt;stdio.h&gt;</code></span></span>
<span class="line" db-line="3"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="4"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">void __attribute__((constructor)) program_init(void)  {</code></span></span>
<span class="line" db-line="5"><span class="ln">  5 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  printf("init\n");</code></span></span>
<span class="line" db-line="6"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
<span class="line" db-line="7"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="8"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">void  __attribute__((destructor)) program_fini(void) {</code></span></span>
<span class="line" db-line="9"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  printf("fini\n");</code></span></span>
<span class="line" db-line="10"><span class="ln"> 10 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
<span class="line" db-line="11"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="12"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">int main(void)</code></span></span>
<span class="line" db-line="13"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">{</code></span></span>
<span class="line" db-line="14"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  return 0;</code></span></span>
<span class="line" db-line="15"><span class="ln"> 15 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">}</code></span></span>
<span class="line" db-line="16"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="17"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ gcc -Wall  -o test test.c</code></span></span>
<span class="line" db-line="18"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="19"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ ./test</code></span></span>
<span class="line" db-line="20"><span class="ln"> 20 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">init</code></span></span>
<span class="line" db-line="21"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">fini</code></span></span>
<span class="line" db-line="22"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="23"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump --disassemble ./test | grep program_init</code></span></span>
<span class="line" db-line="24"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">08048398 &lt;program_init&gt;:</code></span></span>
<span class="line" db-line="25"><span class="ln"> 25 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="26"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump --disassemble ./test | grep program_fini</code></span></span>
<span class="line" db-line="27"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">080483b0 &lt;program_fini&gt;:</code></span></span>
<span class="line" db-line="28"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="29"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump --disassemble ./test </code></span></span>
<span class="line" db-line="30"><span class="ln"> 30 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="31"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">[...]</code></span></span>
<span class="line" db-line="32"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">08048280 &lt;_init&gt;:</code></span></span>
<span class="line" db-line="33"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048280:       55                      push   %ebp</code></span></span>
<span class="line" db-line="34"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048281:       89 e5                   mov    %esp,%ebp</code></span></span>
<span class="line" db-line="35"><span class="ln"> 35 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048283:       83 ec 08                sub    $0x8,%esp</code></span></span>
<span class="line" db-line="36"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048286:       e8 79 00 00 00          call   8048304 &lt;call_gmon_start&gt;</code></span></span>
<span class="line" db-line="37"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 804828b:       e8 e0 00 00 00          call   8048370 &lt;frame_dummy&gt;</code></span></span>
<span class="line" db-line="38"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048290:       e8 2b 02 00 00          call   80484c0 &lt;__do_global_ctors_aux&gt;</code></span></span>
<span class="line" db-line="39"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048295:       c9                      leave</code></span></span>
<span class="line" db-line="40"><span class="ln"> 40 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8048296:       c3                      ret</code></span></span>
<span class="line" db-line="41"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">[...]</code></span></span>
<span class="line" db-line="42"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="43"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">080484c0 &lt;__do_global_ctors_aux&gt;:</code></span></span>
<span class="line" db-line="44"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484c0:       55                      push   %ebp</code></span></span>
<span class="line" db-line="45"><span class="ln"> 45 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484c1:       89 e5                   mov    %esp,%ebp</code></span></span>
<span class="line" db-line="46"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484c3:       53                      push   %ebx</code></span></span>
<span class="line" db-line="47"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484c4:       52                      push   %edx</code></span></span>
<span class="line" db-line="48"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484c5:       a1 2c 95 04 08          mov    0x804952c,%eax</code></span></span>
<span class="line" db-line="49"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484ca:       83 f8 ff                cmp    $0xffffffff,%eax</code></span></span>
<span class="line" db-line="50"><span class="ln"> 50 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484cd:       74 1e                   je     80484ed &lt;__do_global_ctors_aux+0x2d&gt;</code></span></span>
<span class="line" db-line="51"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484cf:       bb 2c 95 04 08          mov    $0x804952c,%ebx</code></span></span>
<span class="line" db-line="52"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484d4:       8d b6 00 00 00 00       lea    0x0(%esi),%esi</code></span></span>
<span class="line" db-line="53"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484da:       8d bf 00 00 00 00       lea    0x0(%edi),%edi</code></span></span>
<span class="line" db-line="54"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484e0:       ff d0                   call   *%eax</code></span></span>
<span class="line" db-line="55"><span class="ln"> 55 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484e2:       8b 43 fc                mov    0xfffffffc(%ebx),%eax</code></span></span>
<span class="line" db-line="56"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484e5:       83 eb 04                sub    $0x4,%ebx</code></span></span>
<span class="line" db-line="57"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484e8:       83 f8 ff                cmp    $0xffffffff,%eax</code></span></span>
<span class="line" db-line="58"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484eb:       75 f3                   jne    80484e0 &lt;__do_global_ctors_aux+0x20&gt;</code></span></span>
<span class="line" db-line="59"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484ed:       58                      pop    %eax</code></span></span>
<span class="line" db-line="60"><span class="ln"> 60 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484ee:       5b                      pop    %ebx</code></span></span>
<span class="line" db-line="61"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484ef:       5d                      pop    %ebp</code></span></span>
<span class="line" db-line="62"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484f0:       c3                      ret</code></span></span>
<span class="line" db-line="63"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484f1:       90                      nop</code></span></span>
<span class="line" db-line="64"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484f2:       90                      nop</code></span></span>
<span class="line" db-line="65"><span class="ln"> 65 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 80484f3:       90                      nop</code></span></span>
<span class="line" db-line="66"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="67"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="68"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ readelf --sections ./test</code></span></span>
<span class="line" db-line="69"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">There are 34 section headers, starting at offset 0xfb0:</code></span></span>
<span class="line" db-line="70"><span class="ln"> 70 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="71"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Section Headers:</code></span></span>
<span class="line" db-line="72"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</code></span></span>
<span class="line" db-line="73"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</code></span></span>
<span class="line" db-line="74"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 1] .interp           PROGBITS        08048114 000114 000013 00   A  0   0  1</code></span></span>
<span class="line" db-line="75"><span class="ln"> 75 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 2] .note.ABI-tag     NOTE            08048128 000128 000020 00   A  0   0  4</code></span></span>
<span class="line" db-line="76"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 3] .hash             HASH            08048148 000148 00002c 04   A  4   0  4</code></span></span>
<span class="line" db-line="77"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 4] .dynsym           DYNSYM          08048174 000174 000060 10   A  5   1  4</code></span></span>
<span class="line" db-line="78"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 5] .dynstr           STRTAB          080481d4 0001d4 00005e 00   A  0   0  1</code></span></span>
<span class="line" db-line="79"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 6] .gnu.version      VERSYM          08048232 000232 00000c 02   A  4   0  2</code></span></span>
<span class="line" db-line="80"><span class="ln"> 80 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 7] .gnu.version_r    VERNEED         08048240 000240 000020 00   A  5   1  4</code></span></span>
<span class="line" db-line="81"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 8] .rel.dyn          REL             08048260 000260 000008 08   A  4   0  4</code></span></span>
<span class="line" db-line="82"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [ 9] .rel.plt          REL             08048268 000268 000018 08   A  4  11  4</code></span></span>
<span class="line" db-line="83"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [10] .init             PROGBITS        08048280 000280 000017 00  AX  0   0  4</code></span></span>
<span class="line" db-line="84"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [11] .plt              PROGBITS        08048298 000298 000040 04  AX  0   0  4</code></span></span>
<span class="line" db-line="85"><span class="ln"> 85 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [12] .text             PROGBITS        080482e0 0002e0 000214 00  AX  0   0 16</code></span></span>
<span class="line" db-line="86"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [13] .fini             PROGBITS        080484f4 0004f4 00001a 00  AX  0   0  4</code></span></span>
<span class="line" db-line="87"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [14] .rodata           PROGBITS        08048510 000510 000012 00   A  0   0  4</code></span></span>
<span class="line" db-line="88"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [15] .eh_frame         PROGBITS        08048524 000524 000004 00   A  0   0  4</code></span></span>
<span class="line" db-line="89"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [16] .ctors            PROGBITS        08049528 000528 00000c 00  WA  0   0  4</code></span></span>
<span class="line" db-line="90"><span class="ln"> 90 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [17] .dtors            PROGBITS        08049534 000534 00000c 00  WA  0   0  4</code></span></span>
<span class="line" db-line="91"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [18] .jcr              PROGBITS        08049540 000540 000004 00  WA  0   0  4</code></span></span>
<span class="line" db-line="92"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [19] .dynamic          DYNAMIC         08049544 000544 0000c8 08  WA  5   0  4</code></span></span>
<span class="line" db-line="93"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [20] .got              PROGBITS        0804960c 00060c 000004 04  WA  0   0  4</code></span></span>
<span class="line" db-line="94"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [21] .got.plt          PROGBITS        08049610 000610 000018 04  WA  0   0  4</code></span></span>
<span class="line" db-line="95"><span class="ln"> 95 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [22] .data             PROGBITS        08049628 000628 00000c 00  WA  0   0  4</code></span></span>
<span class="line" db-line="96"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [23] .bss              NOBITS          08049634 000634 000004 00  WA  0   0  4</code></span></span>
<span class="line" db-line="97"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [24] .comment          PROGBITS        00000000 000634 00018f 00      0   0  1</code></span></span>
<span class="line" db-line="98"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [25] .debug_aranges    PROGBITS        00000000 0007c8 000078 00      0   0  8</code></span></span>
<span class="line" db-line="99"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [26] .debug_pubnames   PROGBITS        00000000 000840 000025 00      0   0  1</code></span></span>
<span class="line" db-line="100"><span class="ln">100 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [27] .debug_info       PROGBITS        00000000 000865 0002e1 00      0   0  1</code></span></span>
<span class="line" db-line="101"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [28] .debug_abbrev     PROGBITS        00000000 000b46 000076 00      0   0  1</code></span></span>
<span class="line" db-line="102"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [29] .debug_line       PROGBITS        00000000 000bbc 0001da 00      0   0  1</code></span></span>
<span class="line" db-line="103"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [30] .debug_str        PROGBITS        00000000 000d96 0000f3 01  MS  0   0  1</code></span></span>
<span class="line" db-line="104"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [31] .shstrtab         STRTAB          00000000 000e89 000127 00      0   0  1</code></span></span>
<span class="line" db-line="105"><span class="ln">105 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [32] .symtab           SYMTAB          00000000 001500 000490 10     33  53  4</code></span></span>
<span class="line" db-line="106"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  [33] .strtab           STRTAB          00000000 001990 000218 00      0   0  1</code></span></span>
<span class="line" db-line="107"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Key to Flags:</code></span></span>
<span class="line" db-line="108"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  W (write), A (alloc), X (execute), M (merge), S (strings)</code></span></span>
<span class="line" db-line="109"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  I (info), L (link order), G (group), x (unknown)</code></span></span>
<span class="line" db-line="110"><span class="ln">110 <span class="nsep">|</span></span><span class="ld"><code class="calibre13">  O (extra OS processing required) o (OS specific), p (processor specific)</code></span></span>
<span class="line" db-line="111"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="112"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">$ objdump --disassemble-all --section .ctors ./test</code></span></span>
<span class="line" db-line="113"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="114"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">./test:     file format elf32-i386</code></span></span>
<span class="line" db-line="115"><span class="ln">115 <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> </code></span></span>
<span class="line" db-line="116"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13">Contents of section .ctors:</code></span></span>
<span class="line" db-line="117"><span class="ln">    <span class="nsep">|</span></span><span class="ld"><code class="calibre13"> 8049528 ffffffff 98830408 00000000           ............</code></span></span>
</pre></div><header class="calibre8"><div class="title"><span>Example<span> </span></span><span>8<span>.</span>2<span>.</span>2<span> </span></span>Constructors and Destructors</div></header></div><p class="releaseinfo">The last value pushed onto the stack for the
      <code class="computeroutput1">__libc_start_main</code> was the
      initialisation function
      <code class="computeroutput1">__libc_csu_init</code>.  If we follow
      the call chain through from
      <code class="computeroutput1">__libc_csu_init</code> we can see it
      does some setup and then calls the
      <code class="computeroutput1">_init</code> function in the
      executable.  The <code class="computeroutput1">_init</code> function
      eventually calls a function called
      <code class="computeroutput1">__do_global_ctors_aux</code>.  Looking
      at the disassembley of this function we can see that it appears
      to start at address <code class="computeroutput1">0x804952c</code>
      and loop along, reading an value and calling it.  We can see
      that this starting address is in the
      <code class="computeroutput1">.ctors</code> section of the file; if
      we have a look inside this we see that it contains the first
      value <code class="computeroutput1">-1</code>, a function address
      (in big endian format) and the value zero.</p><p class="releaseinfo">The address in big endian format is
      <code class="computeroutput1">0x08048398</code>, or the address of
      <code class="computeroutput1">program_init</code> function!  So the
      format of the <code class="computeroutput1">.ctors</code> section is
      firstly a -1, and then the address of functions to be called on
      initialisation, and finally a zero to indicate the list is
      complete.  Each entry will be called (in this case we only have
      the one function).</p><p class="releaseinfo">Once <code class="computeroutput1">__libc_start_main</code>
      has completed with the <code class="computeroutput1">_init</code>
      call it <em class="calibre5">finally</em> calls the
      <code class="computeroutput1">main()</code> function!  Remember that
      it had the stack setup initially with the arguments and
      environment pointers from the kernel; this is how main gets its
      <code class="computeroutput1">argc, argv[], envp[]</code> arguments.
      The process now runs and the setup phase is complete.</p><p class="releaseinfo">A similar process is enacted with the
      <code class="computeroutput1">.dtors</code> for destructors when the
      program exits.
      <code class="computeroutput1">__libc_start_main</code> calls these
      when the <code class="computeroutput1">main()</code> function
      completes.</p><p class="releaseinfo">As you can see, a lot is done before the program gets to
      start, and even a little after you think it is finished!</p></section></section></div><div id="chapter08" class="author"><header class="calibre6"><div class="calibre10" id="calibre_pb_64"/>
</header></div></main></body></html>