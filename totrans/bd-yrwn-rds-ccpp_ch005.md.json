["```cpp\n+-----+------+-----+------+--------\n| len | msg1 | len | msg2 | more...\n+-----+------+-----+------+--------\n```", "```cpp\n[](#cb2-1)    while (true) {\n[](#cb2-2)        // accept\n[](#cb2-3)        struct sockaddr_in client_addr = {};\n[](#cb2-4)        socklen_t socklen = sizeof(client_addr);\n[](#cb2-5)        int connfd = accept(fd, (struct sockaddr *)&client_addr, &socklen);\n[](#cb2-6)        if (connfd < 0) {\n[](#cb2-7)            continue;   // error\n[](#cb2-8)        }\n[](#cb2-9)\n[](#cb2-10)        // only serves one client connection at once\n[](#cb2-11)        while (true) {\n[](#cb2-12)            int32_t err = one_request(connfd);\n[](#cb2-13)            if (err) {\n[](#cb2-14)                break;\n[](#cb2-15)            }\n[](#cb2-16)        }\n[](#cb2-17)        close(connfd);\n[](#cb2-18)    }\n```", "```cpp\n[](#cb3-1)static int32_t read_full(int fd, char *buf, size_t n) {\n[](#cb3-2)    while (n > 0) {\n[](#cb3-3)        ssize_t rv = read(fd, buf, n);\n[](#cb3-4)        if (rv <= 0) {\n[](#cb3-5)            return -1;  // error, or unexpected EOF\n[](#cb3-6)        }\n[](#cb3-7)        assert((size_t)rv <= n);\n[](#cb3-8)        n -= (size_t)rv;\n[](#cb3-9)        buf += rv;\n[](#cb3-10)    }\n[](#cb3-11)    return 0;\n[](#cb3-12)}\n[](#cb3-13)\n[](#cb3-14)static int32_t write_all(int fd, const char *buf, size_t n) {\n[](#cb3-15)    while (n > 0) {\n[](#cb3-16)        ssize_t rv = write(fd, buf, n);\n[](#cb3-17)        if (rv <= 0) {\n[](#cb3-18)            return -1;  // error\n[](#cb3-19)        }\n[](#cb3-20)        assert((size_t)rv <= n);\n[](#cb3-21)        n -= (size_t)rv;\n[](#cb3-22)        buf += rv;\n[](#cb3-23)    }\n[](#cb3-24)    return 0;\n[](#cb3-25)}\n```", "```cpp\n[](#cb4-1)const size_t k_max_msg = 4096;\n[](#cb4-2)\n[](#cb4-3)static int32_t one_request(int connfd) {\n[](#cb4-4)    // 4 bytes header\n[](#cb4-5)    char rbuf[4 + k_max_msg + 1];\n[](#cb4-6)    errno = 0;\n[](#cb4-7)    int32_t err = read_full(connfd, rbuf, 4);\n[](#cb4-8)    if (err) {\n[](#cb4-9)        if (errno == 0) {\n[](#cb4-10)            msg(\"EOF\");\n[](#cb4-11)        } else {\n[](#cb4-12)            msg(\"read() error\");\n[](#cb4-13)        }\n[](#cb4-14)        return err;\n[](#cb4-15)    }\n[](#cb4-16)\n[](#cb4-17)    uint32_t len = 0;\n[](#cb4-18)    memcpy(&len, rbuf, 4);  // assume little endian\n[](#cb4-19)    if (len > k_max_msg) {\n[](#cb4-20)        msg(\"too long\");\n[](#cb4-21)        return -1;\n[](#cb4-22)    }\n[](#cb4-23)\n[](#cb4-24)    // request body\n[](#cb4-25)    err = read_full(connfd, &rbuf[4], len);\n[](#cb4-26)    if (err) {\n[](#cb4-27)        msg(\"read() error\");\n[](#cb4-28)        return err;\n[](#cb4-29)    }\n[](#cb4-30)\n[](#cb4-31)    // do something\n[](#cb4-32)    rbuf[4 + len] = '\\0';\n[](#cb4-33)    printf(\"client says: %s\\n\", &rbuf[4]);\n[](#cb4-34)\n[](#cb4-35)    // reply using the same protocol\n[](#cb4-36)    const char reply[] = \"world\";\n[](#cb4-37)    char wbuf[4 + sizeof(reply)];\n[](#cb4-38)    len = (uint32_t)strlen(reply);\n[](#cb4-39)    memcpy(wbuf, &len, 4);\n[](#cb4-40)    memcpy(&wbuf[4], reply, len);\n[](#cb4-41)    return write_all(connfd, wbuf, 4 + len);\n[](#cb4-42)}\n```", "```cpp\n[](#cb5-1)static int32_t query(int fd, const char *text) {\n[](#cb5-2)    uint32_t len = (uint32_t)strlen(text);\n[](#cb5-3)    if (len > k_max_msg) {\n[](#cb5-4)        return -1;\n[](#cb5-5)    }\n[](#cb5-6)\n[](#cb5-7)    char wbuf[4 + k_max_msg];\n[](#cb5-8)    memcpy(wbuf, &len, 4);  // assume little endian\n[](#cb5-9)    memcpy(&wbuf[4], text, len);\n[](#cb5-10)    if (int32_t err = write_all(fd, wbuf, 4 + len)) {\n[](#cb5-11)        return err;\n[](#cb5-12)    }\n[](#cb5-13)\n[](#cb5-14)    // 4 bytes header\n[](#cb5-15)    char rbuf[4 + k_max_msg + 1];\n[](#cb5-16)    errno = 0;\n[](#cb5-17)    int32_t err = read_full(fd, rbuf, 4);\n[](#cb5-18)    if (err) {\n[](#cb5-19)        if (errno == 0) {\n[](#cb5-20)            msg(\"EOF\");\n[](#cb5-21)        } else {\n[](#cb5-22)            msg(\"read() error\");\n[](#cb5-23)        }\n[](#cb5-24)        return err;\n[](#cb5-25)    }\n[](#cb5-26)\n[](#cb5-27)    memcpy(&len, rbuf, 4);  // assume little endian\n[](#cb5-28)    if (len > k_max_msg) {\n[](#cb5-29)        msg(\"too long\");\n[](#cb5-30)        return -1;\n[](#cb5-31)    }\n[](#cb5-32)\n[](#cb5-33)    // reply body\n[](#cb5-34)    err = read_full(fd, &rbuf[4], len);\n[](#cb5-35)    if (err) {\n[](#cb5-36)        msg(\"read() error\");\n[](#cb5-37)        return err;\n[](#cb5-38)    }\n[](#cb5-39)\n[](#cb5-40)    // do something\n[](#cb5-41)    rbuf[4 + len] = '\\0';\n[](#cb5-42)    printf(\"server says: %s\\n\", &rbuf[4]);\n[](#cb5-43)    return 0;\n[](#cb5-44)}\n```", "```cpp\n[](#cb6-1)int main() {\n[](#cb6-2)    int fd = socket(AF_INET, SOCK_STREAM, 0);\n[](#cb6-3)    if (fd < 0) {\n[](#cb6-4)        die(\"socket()\");\n[](#cb6-5)    }\n[](#cb6-6)\n[](#cb6-7)    // code omitted ...\n[](#cb6-8)\n[](#cb6-9)    // multiple requests\n[](#cb6-10)    int32_t err = query(fd, \"hello1\");\n[](#cb6-11)    if (err) {\n[](#cb6-12)        goto L_DONE;\n[](#cb6-13)    }\n[](#cb6-14)    err = query(fd, \"hello2\");\n[](#cb6-15)    if (err) {\n[](#cb6-16)        goto L_DONE;\n[](#cb6-17)    }\n[](#cb6-18)    err = query(fd, \"hello3\");\n[](#cb6-19)    if (err) {\n[](#cb6-20)        goto L_DONE;\n[](#cb6-21)    }\n[](#cb6-22)\n[](#cb6-23)L_DONE:\n[](#cb6-24)    close(fd);\n[](#cb6-25)    return 0;\n[](#cb6-26)}\n```", "```cpp\n[](#cb7-1)$ ./server\n[](#cb7-2)client says: hello1\n[](#cb7-3)client says: hello2\n[](#cb7-4)client says: hello3\n[](#cb7-5)EOF\n[](#cb7-6)\n[](#cb7-7)$ ./client\n[](#cb7-8)server says: world\n[](#cb7-9)server says: world\n[](#cb7-10)server says: world\n```"]