- en: The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better
- en: 原文：[https://enhancedformysql.github.io/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Chapter11.html](https://enhancedformysql.github.io/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Chapter11.html)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 原文：[https://enhancedformysql.github.io/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Chapter11.html](https://enhancedformysql.github.io/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Chapter11.html)
- en: 'Chapter 11: Performance Tuning'
  id: totrans-2
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第11章：性能调优
- en: This chapter primarily addresses methods for improving MySQL application performance
    without altering the MySQL source code.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 本章主要讨论在不修改MySQL源代码的情况下提高MySQL应用程序性能的方法。
- en: 11.1 PGO
  id: totrans-4
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.1 PGO
- en: Profile-guided optimization (PGO) typically improves program execution efficiency.
    The following figure illustrates how PGO improves the throughput of a standalone
    MySQL instance under various concurrency levels, following the resolution of MySQL
    MVCC ReadView scalability problems.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 基于配置文件优化的（PGO）通常可以提高程序执行效率。以下图表展示了在解决MySQL MVCC ReadView可伸缩性问题后，PGO如何提高不同并发级别下独立MySQL实例的吞吐量。
- en: '![image-20240829113916829](../Images/64908cc891a314429011e7b7819a1162.png)'
  id: totrans-6
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829113916829](../Images/64908cc891a314429011e7b7819a1162.png)'
- en: Figure 11-1\. Impact of PGO after solving MVCC ReadView scalability problems.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-1\. 解决MVCC ReadView可伸缩性问题后PGO的影响。
- en: From the figure, it is evident that PGO has a notable impact.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，PGO具有显著的影响。
- en: 'For MySQL 8.0.27 with PGO, throughput decreases under high concurrency conditions.
    The specific details are shown in the figure below:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 对于MySQL 8.0.27使用PGO，在高并发条件下吞吐量会下降。具体细节如下图所示：
- en: '![image-20240829113948830](../Images/d73bbbf5f2a1d23c4b239abb2372f451.png)'
  id: totrans-10
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829113948830](../Images/d73bbbf5f2a1d23c4b239abb2372f451.png)'
- en: Figure 11-2\. Performance comparison tests before and after using PGO in MySQL
    8.0.27.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-2\. 在MySQL 8.0.27中使用PGO前后的性能比较测试。
- en: The test results above indicate that PGO for MySQL’s improvement requires addressing
    scalability problems before its full potential can be realized. It should be noted
    that both comparative tests above were conducted in mainstream NUMA environments.
    When MySQL is bound to a single NUMA node, creating an SMP environment, the following
    figure shows the relationship between TPC-C throughput and concurrency levels
    before and after PGO.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 上述测试结果表明，为了充分发挥PGO对MySQL的改进作用，需要解决可伸缩性问题。需要注意的是，上述两种比较测试都是在主流NUMA环境中进行的。当MySQL绑定到单个NUMA节点时，创建SMP环境，以下图表显示了在PGO前后TPC-C吞吐量与并发级别之间的关系。
- en: '![image-20240829114017540](../Images/b5e536cbe6211ce3585e62105caf7b20.png)'
  id: totrans-13
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829114017540](../Images/b5e536cbe6211ce3585e62105caf7b20.png)'
- en: Figure 11-3\. Performance comparison tests before and after using PGO in MySQL
    8.0.27 under SMP.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-3\. 在MySQL 8.0.27下使用PGO前后的性能比较测试。
- en: From the figure, it can be seen that PGO consistently improves throughput in
    SMP environments, without decreasing as concurrency levels increase. The following
    figure compares the performance improvement of PGO between NUMA and SMP environments.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，PGO在SMP环境中持续提高吞吐量，并不会随着并发级别的增加而降低。以下图表比较了NUMA和SMP环境中PGO的性能提升。
- en: '![image-20240829114037360](../Images/ad8301738e16e1ae14d2ef01d6b46987.png)'
  id: totrans-16
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829114037360](../Images/ad8301738e16e1ae14d2ef01d6b46987.png)'
- en: Figure 11-4\. Performance of PGO optimization in different environments.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-4\. 不同环境下PGO优化的性能。
- en: From the figure, it is evident that PGO achieves a maximum performance improvement
    of up to 30% in SMP environments, whereas in NUMA environments, the performance
    improvement decreases as concurrency increases. This suggests that PGO has greater
    potential in SMP environments.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，PGO在SMP环境中实现了高达30%的最大性能提升，而在NUMA环境中，随着并发的增加，性能提升逐渐降低。这表明PGO在SMP环境中具有更大的潜力。
- en: Continuing the analysis, the performance of PGO in a Group Replication cluster
    environment compared to a single MySQL instance is examined. The following diagram
    depicts a simplified queue model of Group Replication.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 继续分析，比较了PGO在组复制集群环境与单个MySQL实例中的性能。以下图表展示了组复制的简化队列模型。
- en: '![](../Images/973f98c3a0023f2eab36f561fa26cdec.png)'
  id: totrans-20
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/973f98c3a0023f2eab36f561fa26cdec.png)'
- en: Figure 11-5\. A simplified queue model of Group Replication.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-5\. 组复制简化队列模型。
- en: Because the network portion cannot be optimized by PGO, the MySQL primary consumes
    a lower proportion of time compared to a single MySQL instance. According to Amdahl’s
    Law, the performance gains from PGO will be less pronounced compared to those
    of a standalone MySQL instance. Generally, as network latency increases, the improvement
    from PGO tends to diminish.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 由于网络部分不能通过PGO进行优化，MySQL主实例相对于单个MySQL实例消耗的时间比例较低。根据Amdahl定律，PGO带来的性能提升将比独立MySQL实例的提升不那么明显。一般来说，随着网络延迟的增加，PGO的改进效果往往会减弱。
- en: The following figure compares the throughput improvement of a standalone MySQL
    instance and Group Replication using PGO.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 下图比较了使用PGO的独立MySQL实例和组复制的吞吐量提升。
- en: '![image-20240829114100020](../Images/eb7c439fada64419f1e607d04eca6d9a.png)'
  id: totrans-24
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829114100020](../Images/eb7c439fada64419f1e607d04eca6d9a.png)'
- en: Figure 11-6\. PGO Performance Improvement in Group Replication vs. Standalone
    MySQL.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-6\. 组复制与独立MySQL的PGO性能提升。
- en: From the figure, it can be observed that the performance improvement from PGO
    in a Group Replication cluster environment is generally less than that of a standalone
    MySQL instance.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，在组复制集群环境中，PGO带来的性能提升通常低于独立MySQL实例。
- en: 'In conclusion, PGO can be summarized as follows:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 总之，PGO可以总结如下：
- en: For MySQL, PGO is a worthwhile optimization that theoretically improves performance
    comprehensively, especially in SMP environments.
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于MySQL，PGO是一种值得优化的方法，理论上可以全面提高性能，尤其是在SMP环境中。
- en: In NUMA environments, addressing scalability problems is necessary to achieve
    significant benefits from PGO.
  id: totrans-29
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在NUMA环境中，解决可伸缩性问题对于从PGO中获得显著效益是必要的。
- en: PGO is less effective in a Group Replication cluster compared to a standalone
    MySQL instance.
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 相比于独立MySQL实例，PGO在组复制集群中的效果较差。
- en: 11.2 Minimize Network Interactions
  id: totrans-31
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.2 最小化网络交互
- en: To improve MySQL application performance without compromising the correctness
    of TPC-C testing, modify the SQL interaction method to reduce the number of network
    interactions between the client and MySQL. This optimization indirectly improves
    performance.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 为了在不影响TPC-C测试正确性的情况下提高MySQL应用程序性能，修改SQL交互方法以减少客户端和MySQL之间的网络交互次数。这种优化间接提高了性能。
- en: The following example uses an optimized tpcc-mysql testing tool to determine
    the maximum throughput supported by Group Replication under specific software
    and hardware conditions.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例使用优化的tpcc-mysql测试工具，在特定的软件和硬件条件下确定组复制支持的最大吞吐量。
- en: '[PRE0]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The data indicates that, in the given software and hardware testing environment,
    Group Replication achieved a peak throughput of 1.066 million tpmC, setting a
    new record.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 数据表明，在给定的软件和硬件测试环境中，组复制实现了106.6万tpmC的峰值吞吐量，创下了新纪录。
- en: This highlights that reducing the number of network interactions with MySQL
    during application development can significantly improve performance.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 这表明在应用程序开发期间减少与MySQL的网络交互次数可以显著提高性能。
- en: 11.3 Utilize Advanced Memory Allocation Tools
  id: totrans-37
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.3 利用高级内存分配工具
- en: MySQL defaults to using the jemalloc memory allocation tool, specifically version
    3.6\. Test data indicates that jemalloc 3.6 is not optimal for performance. The
    following figure shows the throughput improvements of jemalloc 4.5 compared to
    jemalloc 3.6 on x86 architecture.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: MySQL默认使用jemalloc内存分配工具，具体版本为3.6。测试数据表明jemalloc 3.6在性能上并非最佳。以下图显示了jemalloc 4.5与jemalloc
    3.6在x86架构上的吞吐量提升。
- en: '![image-20240829114526325](../Images/3a2d838f0d31ac77045ec3f98146c3bb.png)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829114526325](../Images/3a2d838f0d31ac77045ec3f98146c3bb.png)'
- en: Figure 11-7\. Jemalloc 4.5 outperforms jemalloc 3.6 in terms of performance.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-7\. jemalloc 4.5在性能上优于jemalloc 3.6。
- en: From the figure, it is evident that jemalloc 4.5 outperforms jemalloc 3.6 in
    terms of performance.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，jemalloc 4.5在性能上优于jemalloc 3.6。
- en: 'For MySQL secondary replay, please refer to the figure below:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 对于MySQL次级回放，请参考以下图：
- en: '![image-20240829114557565](../Images/1163b75fd7d7a4ad27438e3f2938c047.png)'
  id: totrans-43
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829114557565](../Images/1163b75fd7d7a4ad27438e3f2938c047.png)'
- en: Figure 11-8\. Achieve better replay speed with jemalloc 4.5.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-8\. 使用jemalloc 4.5实现更好的回放速度。
- en: Tests with optimized MySQL replay showed a notable difference between jemalloc
    3.6 and jemalloc 4.5\. The figure illustrates a significant improvement in balanced
    replay speed with jemalloc 4.5.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 使用优化后的MySQL回放进行的测试显示了jemalloc 3.6和jemalloc 4.5之间的显著差异。该图说明了jemalloc 4.5在平衡回放速度方面的显著提升。
- en: An effective memory allocation tool not only boosts MySQL primary server performance
    but also improves the replay speed of MySQL secondaries.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 一个有效的内存分配工具不仅可以提高 MySQL 主服务器的性能，还可以提高 MySQL 从属服务器的重放速度。
- en: 11.4 Indexes and Performance
  id: totrans-47
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.4 索引与性能
- en: Section 4.10.6 provides detailed information on this topic.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 4.10.6 节提供了关于此主题的详细信息。
- en: 11.5 Key MySQL Parameters Influencing Performance
  id: totrans-49
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.5 影响性能的关键 MySQL 参数
- en: Databases feature numerous tunable system parameters that control crucial aspects
    such as memory allocation, I/O management, and logging. The impact of these parameters
    can vary greatly depending on the configuration, ranging from significant to minimal
    effects. This variability is due to the multitude of factors influencing MySQL
    performance, which complicates the prediction of performance outcomes. However,
    it is possible to identify specific factors that lead to abnormal throughput.
    The following sections detail commonly used parameters that affect performance.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 数据库具有许多可调整的系统参数，这些参数控制着诸如内存分配、I/O 管理和日志记录等关键方面。这些参数的影响可能因配置而异，从显著到最小效果不等。这种可变性是由于影响
    MySQL 性能的众多因素造成的，这使得预测性能结果变得复杂。然而，可以确定导致异常吞吐量的特定因素。以下各节详细介绍了影响性能的常用参数。
- en: 11.5.1 Impact of ‘Dual One’ on Performance
  id: totrans-51
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.1 “双一”对性能的影响
- en: 'The ‘dual one’ configuration parameters include two parameters: *sync_binlog*
    and *innodb_flush_log_at_trx_commit*.'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: “双一”配置参数包括两个参数：*sync_binlog* 和 *innodb_flush_log_at_trx_commit*。
- en: 'The *sync_binlog* parameter is described as follows:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: '*sync_binlog* 参数描述如下：'
- en: '![](../Images/78880b6b0fe42a005212b84cdd618573.png)'
  id: totrans-54
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/78880b6b0fe42a005212b84cdd618573.png)'
- en: The following configuration controls how often the MySQL Server synchronizes
    the binary log to disk.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 以下配置控制 MySQL 服务器将二进制日志同步到磁盘的频率。
- en: '![](../Images/81c3390b4d9b179bfe2fb63d9150ffe1.png)'
  id: totrans-56
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/81c3390b4d9b179bfe2fb63d9150ffe1.png)'
- en: 'The *innodb_flush_log_at_trx_commit* parameter is described as follows:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '*innodb_flush_log_at_trx_commit* 参数描述如下：'
- en: '![](../Images/76233c60f51ffe40bd2c964a1e80040f.png)'
  id: totrans-58
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/76233c60f51ffe40bd2c964a1e80040f.png)'
- en: The following configuration balances strict ACID compliance for commit operations
    with the higher performance achievable by rearranging and batching commit-related
    I/O operations. Adjusting the default value can improve performance but may result
    in transaction loss in the event of a crash.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 以下配置在保持提交操作的严格 ACID 兼容性的同时，通过重新排列和批量处理与提交相关的 I/O 操作，实现了更高的性能。调整默认值可以提高性能，但在崩溃事件中可能会导致事务丢失。
- en: '![](../Images/c1ff7aaca0d4e09b2b1a33cf76cbcb35.png)'
  id: totrans-60
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/c1ff7aaca0d4e09b2b1a33cf76cbcb35.png)'
- en: It’s important to note that with the improved scalability in MySQL 8.0 and optimizations
    in redo log handling, the effect of disabling ‘dual one’ settings on throughput
    for MySQL primary servers in high-concurrency test scenarios has diminished.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 需要注意的是，随着 MySQL 8.0 的可扩展性改进和重做日志处理的优化，禁用“双一”设置对高并发测试场景中 MySQL 主服务器的吞吐量影响已经减弱。
- en: Comparative tests were first conducted using MySQL 8.0.27\. The figure below
    illustrates the relationship between throughput and concurrency with ‘dual one’
    enabled and disabled.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 首先进行了使用 MySQL 8.0.27 的比较测试。下图展示了启用和禁用“双一”时吞吐量和并发的关系。
- en: '![image-20240829114945572](../Images/ae58d9d8183bbbae82b503606a8a067d.png)'
  id: totrans-63
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829114945572](../Images/ae58d9d8183bbbae82b503606a8a067d.png)'
- en: Figure 11-9\. Achieve better performance with ‘dual one’ disabled.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-9\. 禁用“双一”后实现更好的性能。
- en: Based on the figure, it is evident that with MySQL 8.0.27, disabling ‘dual one’
    significantly improves throughput. However, this performance gain diminishes as
    concurrency increases.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 根据图示，很明显，在 MySQL 8.0.27 中，禁用“双一”显著提高了吞吐量。然而，随着并发的增加，这种性能提升会减弱。
- en: 'Based on the improved version of MySQL with PGO, the performance improvement
    after disabling ‘dual one’ is less significant, as shown in the figure below:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 基于带有 PGO 改进的 MySQL 版本，禁用“双一”后的性能提升并不显著，如图下所示：
- en: '![image-20240829115033197](../Images/b7875f96afc343d89d8a2329d46c54e9.png)'
  id: totrans-67
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115033197](../Images/b7875f96afc343d89d8a2329d46c54e9.png)'
- en: Figure 11-10\. Less performance gain with ‘dual one’ disabled after addressing
    scalability bottlenecks in MySQL.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-10\. 在解决 MySQL 的可扩展性瓶颈后，禁用“双一”后性能提升较少。
- en: It can also be observed that the extent of performance improvement varies with
    throughput and is not constant. As scalability bottlenecks in MySQL are addressed,
    the impact of ‘dual one’ diminishes.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 还可以观察到，性能改进的程度随着吞吐量的变化而变化，并不恒定。随着MySQL可扩展性瓶颈的解决，‘双重一’的影响减小。
- en: The impact of ‘dual one’ on MySQL secondary replay is more pronounced due to
    mechanisms such as the re*plica_preserve_commit_order* queueing. The figure below
    compares the balanced replay speeds of MySQL secondaries before and after disabling
    ‘dual one’ using an optimized MySQL version.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 由于存在如**replica_preserve_commit_order**队列等机制，‘双重一’对MySQL从库回放的影响更为明显。下图使用优化后的MySQL版本比较了禁用‘双重一’前后MySQL从库的平衡回放速度。
- en: '![image-20240829115125819](../Images/ccc2fee17d2299f5a3d60635b417f751.png)'
  id: totrans-71
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115125819](../Images/ccc2fee17d2299f5a3d60635b417f751.png)'
- en: Figure 11-11\. Achieve better replay speed with ‘dual one’ closed.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-11\. 关闭“双重一”以实现更好的回放速度。
- en: Under equivalent conditions, disabling ‘dual one’ achieved a balanced replay
    speed of 810,000 tpmC for MySQL secondaries, while enabling ‘dual one’ reduced
    this speed to approximately 700,000 tpmC. Thus, disabling ‘dual one’ significantly
    improves the replay speed of MySQL secondaries.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: 在等效条件下，禁用“双重一”实现了MySQL从库的平衡回放速度为810,000 tpmC，而启用“双重一”将此速度降低到大约700,000 tpmC。因此，禁用“双重一”显著提高了MySQL从库的回放速度。
- en: Note that the above test results were obtained in a high-performance SSD environment,
    and differences in SSD hardware performance can lead to varying results.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，上述测试结果是在高性能SSD环境中获得的，SSD硬件性能的差异可能导致结果不同。
- en: 11.5.2 Performance Effects of Disabling Binlog
  id: totrans-75
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.2 禁用binlog的性能影响
- en: With binary logging enabled, the server logs all statements that modify data
    to the binary log, which is utilized for backup and replication purposes. Disabling
    binlog can theoretically eliminate queue wait times, thereby improving throughput
    and reducing response times.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 当启用二进制日志时，服务器将所有修改数据的语句记录到二进制日志中，该日志用于备份和复制目的。理论上，禁用binlog可以消除队列等待时间，从而提高吞吐量和减少响应时间。
- en: The figure below compares TPC-C throughput at identical concurrency levels before
    and after disabling binlog, using BenchmarkSQL.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 下图使用BenchmarkSQL比较了禁用binlog前后在相同并发级别下的TPC-C吞吐量。
- en: '![image-20240829115210707](../Images/c9980275b579056f568f1a31f8744d33.png)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115210707](../Images/c9980275b579056f568f1a31f8744d33.png)'
- en: Figure 11-12\. Achieve better performance with binlog disabled
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-12\. 禁用binlog以实现更好的性能
- en: From the figure, it is evident that disabling binlog noticeably impacts performance.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，禁用binlog对性能有显著影响。
- en: 11.5.3 Understanding the Spin Delay Parameter’s Effect on Performance
  id: totrans-81
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.3 理解自旋延迟参数对性能的影响
- en: Contending threads must wait for a lock when it’s unavailable. Several waiting
    policies exist, with unbounded spinning (or busy waiting) being the simplest.
    In this approach, threads repeatedly check a memory location until the value changes.
    This method consumes resources and may lead to preemption in an oversubscribed
    system with more threads than CPUs [3].
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 当锁不可用时，竞争线程必须等待。存在几种等待策略，其中无界自旋（或忙等待）是最简单的。在这种方法中，线程会反复检查一个内存位置，直到其值发生变化。这种方法会消耗资源，并可能导致在线程数量多于CPU数量的过载系统中出现抢占
    [3]。
- en: '**Advantages of Spinning:**'
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: '**自旋的优势：**'
- en: In an unloaded system, spinning offers high performance with minimal overhead,
    as it avoids OS coordination and incurs only a few cache miss latencies per lock
    handoff. On chip multiprocessors with shared caches, lock acquisition and release
    latencies can be as low as 150 ns.
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在无负载系统中，自旋以最小的开销提供高性能，因为它避免了操作系统协调，并且每次锁传递仅产生几个缓存未命中延迟。在具有共享缓存的芯片多处理器上，锁获取和释放延迟可以低至150纳秒。
- en: '**Disadvantages of Spinning:**'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: '**自旋的缺点：**'
- en: When the system is loaded, spinning can degrade performance as it reduces the
    number of processors available for useful work, leading to suboptimal performance
    when runnable threads exceed hardware contexts. Additionally, since spinning isn’t
    coordinated with the OS, it doesn’t account for lock holders or spinners in scheduling
    decisions.
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 当系统负载时，自旋会降低性能，因为它减少了可用于有用工作的处理器数量，当可运行线程超过硬件上下文时，会导致性能不佳。此外，由于自旋没有与操作系统协调，它没有在调度决策中考虑锁持有者或自旋者。
- en: The spin delay parameter helps address NUMA (Non-Uniform Memory Access) compatibility
    problems. Generally, better MySQL scalability reduces the impact of the spin delay
    parameter. Conversely, in cases of poor scalability, the spin delay parameter
    noticeably affects performance, although its effectiveness has an upper limit.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 自旋延迟参数有助于解决 NUMA（非一致性内存访问）兼容性问题。通常，更好的 MySQL 可伸缩性会减少自旋延迟参数的影响。相反，在可伸缩性较差的情况下，自旋延迟参数会明显影响性能，尽管其有效性有上限。
- en: Based on the MySQL 8.0.21 version with lock-sys optimization, the figure below
    compares TPC-C throughput at various concurrency levels.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 基于带有锁-sys 优化的 MySQL 8.0.21 版本，以下图表比较了各种并发级别下的 TPC-C 吞吐量。
- en: '![image-20240829115241352](../Images/10075f1a30bed46090c12c614f1e79b8.png)'
  id: totrans-89
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115241352](../Images/10075f1a30bed46090c12c614f1e79b8.png)'
- en: Figure 11-13\. Achieve better performance with spin delay 20 in MySQL 8.0.21.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-13\. 在 MySQL 8.0.21 中使用自旋延迟 20 实现更好的性能。
- en: The figure shows that setting *spin_delay=20* significantly mitigates the scalability
    problems of MySQL 8.0.21 with lock-sys optimization. However, in high-concurrency
    scenarios, the spin delay parameter can substantially increase CPU overhead. According
    to the paper “Locking Made Easy”, simple spinlocks are very efficient under low
    contention but do not scale well [63].
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 图表显示，设置 *spin_delay=20* 显著缓解了带有锁-sys 优化的 MySQL 8.0.21 的可伸缩性问题。然而，在高并发场景下，自旋延迟参数可能会显著增加
    CPU 负担。根据论文“Locking Made Easy”，在低竞争情况下，简单的自旋锁非常高效，但可扩展性不佳 [63]。
- en: Further analysis of the spin delay parameter in MySQL versions prior to MVCC
    ReadView optimization, with PGO compilation, is detailed in the following figure.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在 MVCC ReadView 优化之前的 MySQL 版本中，对自旋延迟参数的进一步分析，以及使用 PGO 编译的详细信息，在下图中详细说明。
- en: '![image-20240829115301443](../Images/64e6be03c702e70b1cca984aecf26bc0.png)'
  id: totrans-93
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115301443](../Images/64e6be03c702e70b1cca984aecf26bc0.png)'
- en: Figure 11-14\. Achieve better performance with spin delay 20 before MVCC ReadView
    optimization.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-14\. 在 MVCC ReadView 优化之前使用自旋延迟 20 实现更好的性能。
- en: From the figure, it’s evident that with the default *spin_delay* parameter set
    to 6, throughput sharply declines at 200 concurrency. However, setting *spin_delay=20*
    leads to a substantial improvement in throughput.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 从图表中可以看出，当默认的 *spin_delay* 参数设置为 6 时，吞吐量在 200 并发时急剧下降。然而，设置 *spin_delay=20*
    导致吞吐量显著提高。
- en: 'Let’s continue with MVCC ReadView optimization to further enhance MySQL scalability.
    The figure below shows the comparison of throughput between MVCC ReadView optimization
    and *spin delay=20*:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们继续进行 MVCC ReadView 优化，以进一步提高 MySQL 的可伸缩性。以下图表显示了 MVCC ReadView 优化与 *spin
    delay=20* 之间的吞吐量比较：
- en: '![image-20240829115320081](../Images/30c9f2e56ccde931dfa67f97fa78615b.png)'
  id: totrans-97
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115320081](../Images/30c9f2e56ccde931dfa67f97fa78615b.png)'
- en: Figure 11-15\. Comparison of throughput between MVCC ReadView optimization and
    spin delay 20.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-15\. MVCC ReadView 优化与自旋延迟 20 之间的吞吐量比较。
- en: From the figure, it can be seen that while spin delay can mitigate scalability
    problems to some extent, its effect is noticeably less pronounced compared to
    the benefits of adopting MVCC ReadView optimization.
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 从图表中可以看出，虽然自旋延迟可以在一定程度上缓解可伸缩性问题，但其效果与采用 MVCC ReadView 优化的好处相比明显不那么显著。
- en: 'After MVCC ReadView optimization, the impact of *spin_delay* was tested again.
    See the specific results in the figure below:'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 在 MVCC ReadView 优化后，再次测试了 *spin_delay* 的影响。具体结果见下图：
- en: '![image-20240829115410814](../Images/3235b5dd1e9d15be286a642a7108ce9b.png)'
  id: totrans-101
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115410814](../Images/3235b5dd1e9d15be286a642a7108ce9b.png)'
- en: Figure 11-16\. Spin delay 20 has no effect after addressing MVCC ReadView scalability
    problems.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-16\. 解决 MVCC ReadView 可伸缩性问题后，自旋延迟 20 无效。
- en: The figure shows that after addressing MVCC ReadView scalability problems, the
    impact of the *spin_delay* parameter is minimal.
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 图表显示，在解决 MVCC ReadView 可伸缩性问题后，*spin_delay* 参数的影响最小。
- en: 11.5.4 Effect of Binlog Commit Order on Performance
  id: totrans-104
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.4 Binlog 提交顺序对性能的影响
- en: 'Here’s a brief introduction to the *binlog_order_commits* parameter:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 下面简要介绍 *binlog_order_commits* 参数：
- en: '![](../Images/2f53695d773dca1dc91eb26e30fb018b.png)'
  id: totrans-106
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/2f53695d773dca1dc91eb26e30fb018b.png)'
- en: When this variable is enabled on a replication source server (default), transaction
    commit instructions to storage engines are serialized on a single thread, ensuring
    transactions commit in the same order as they are written to the binary log. Disabling
    this variable permits transaction commit instructions to be issued using multiple
    threads. Used in combination with binary log group commit, this prevents the commit
    rate of a single transaction being a bottleneck to throughput, and might therefore
    produce a performance improvement [13].
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 当此变量在复制源服务器上启用（默认）时，事务提交指令在单个线程上序列化，确保事务以与它们写入二进制日志相同的顺序提交。禁用此变量允许使用多个线程发布事务提交指令。与二进制日志分组提交结合使用，这可以防止单个事务的提交率成为吞吐量的瓶颈，因此可能产生性能提升
    [13]。
- en: 'Based on the MySQL 8.0.27 version, examining whether enabling the *binlog_order_commit*
    parameter affects TPC-C throughput. See the specific comparison in the figure
    below:'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 基于 MySQL 8.0.27 版本，检查启用 *binlog_order_commit* 参数是否会影响 TPC-C 吞吐量。具体比较见下图的说明：
- en: '![image-20240829115454755](../Images/3f6bda30b8ced873fb70e00c012a0414.png)'
  id: totrans-109
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115454755](../Images/3f6bda30b8ced873fb70e00c012a0414.png)'
- en: Figure 11-17\. Achieve better performance with binlog_order_commits off before
    binlog group commit optimization.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-17\. 在 binlog 分组提交优化之前关闭 binlog_order_commits 以获得更好的性能。
- en: From the figure, it can be observed that disabling *binlog_order_commits* results
    in a noticeable improvement in TPC-C throughput under different concurrency levels.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，禁用 *binlog_order_commits* 在不同的并发级别下导致 TPC-C 吞吐量有明显的提升。
- en: The following figure is based on the improved MySQL version, optimized with
    PGO settings. Disabling *binlog_order_commits* shows less pronounced improvement
    in TPC-C throughput. Addressing problems like the thundering herd problem caused
    by binlog group commit has improved MySQL efficiency and mitigated the performance
    degradation observed when *binlog_order_commits* is enabled.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 下图基于改进的 MySQL 版本，使用 PGO 设置进行优化。禁用 *binlog_order_commits* 显示 TPC-C 吞吐量的提升并不明显。解决由
    binlog 分组提交引起的雷鸣效应等问题，提高了 MySQL 的效率，并减轻了启用 *binlog_order_commits* 时观察到的性能下降。
- en: '![image-20240901095750255](../Images/a1df6e716da09499b62431a43a4b7824.png)'
  id: totrans-113
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240901095750255](../Images/a1df6e716da09499b62431a43a4b7824.png)'
- en: Figure 11-18\. Less performance gain with binlog_order_commits off after binlog
    group commit optimization.
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-18\. 在 binlog 分组提交优化后，关闭 binlog_order_commits 后性能提升较少。
- en: MySQL defaults to enabling *binlog_order_commits*. Notably, disabling *binlog_order_commits*
    will affect MySQL’s clone functionality.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: MySQL 默认启用 *binlog_order_commits*。值得注意的是，禁用 *binlog_order_commits* 将影响 MySQL
    的克隆功能。
- en: 11.5.5 Comprehensive Understanding of the Performance Schema on Performance
  id: totrans-116
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.5 对性能模式性能的全面理解
- en: The Performance Schema helps DBAs tune performance by taking real measurements
    instead of making guesses. Unfortunately, in NUMA environments, enabling the Performance
    Schema impacts MySQL’s performance, especially affecting MySQL secondary replay.
    The figure below compares TPC-C throughput across different concurrency levels
    using BenchmarkSQL to analyze this impact.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 性能模式通过进行实际测量而不是猜测来帮助 DBA 调整性能。不幸的是，在 NUMA 环境中，启用性能模式会影响 MySQL 的性能，特别是影响 MySQL
    的二级重放。下图使用 BenchmarkSQL 分析了这种影响，比较了不同并发级别下的 TPC-C 吞吐量。
- en: '![image-20240829115606145](../Images/3e7077449a4b64eb1c12bb7caecd96ca.png)'
  id: totrans-118
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115606145](../Images/3e7077449a4b64eb1c12bb7caecd96ca.png)'
- en: Figure 11-19\. Achieve better performance with performance_schema off.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-19\. 关闭 performance_schema 以获得更好的性能。
- en: From the figure, it can be seen that the Performance Schema has a relatively
    minor impact on MySQL primary performance, which is generally acceptable to users.
    However, enabling the Performance Schema significantly affects the replay speed
    of MySQL secondaries. The following figure shows the change in the replay queue
    size of Group Replication after enabling the Performance Schema.
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，性能模式对 MySQL 的主性能影响相对较小，这通常是可以接受的。然而，启用性能模式显著影响了 MySQL 二级的重放速度。下图显示了启用性能模式后，组复制重放队列大小的变化。
- en: '![](../Images/7fe5bbba0f8180613159487081e9fd0b.png)'
  id: totrans-121
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/7fe5bbba0f8180613159487081e9fd0b.png)'
- en: Figure 11-20\. The replay queue size in Group Replication increases after enabling
    the Performance Schema.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-20\. 启用性能模式后，组复制中的重放队列大小增加。
- en: 'From the figure, it can be observed that the replay queue size is increasing,
    indicating that the MySQL secondary is unable to keep up with the processing speed
    of the MySQL primary. The throughput results after executing on the MySQL primary
    are as follows:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，回放队列大小在增加，这表明 MySQL 从机无法跟上 MySQL 主机的处理速度。在 MySQL 主机上执行后的吞吐量结果如下：
- en: '![](../Images/ea4010003fba7672c7497275b6d8a86a.png)'
  id: totrans-124
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/ea4010003fba7672c7497275b6d8a86a.png)'
- en: 'After the MySQL primary completes execution, here are the performance screenshots
    captured during the replay process on the MySQL secondary:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: MySQL 主机完成执行后，以下是 MySQL 从机在回放过程中捕获的性能截图：
- en: '![](../Images/a87f2152bd7c6fa0d71714ffc5711edb.png)'
  id: totrans-126
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/a87f2152bd7c6fa0d71714ffc5711edb.png)'
- en: Figure 11-21\. Significant bottlenecks related to the Performance Schema.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-21。与性能模式相关的显著瓶颈。
- en: From the highlighted green box, it is apparent that there are significant bottlenecks
    related to the Performance Schema.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 从高亮的绿色框中可以看出，存在与性能模式相关的显著瓶颈。
- en: 'To summarize the test results above: When the MySQL primary achieves a throughput
    of 500,000 tpmC, the MySQL secondary, with the Performance Schema enabled, shows
    clear bottlenecks. Additionally, the MySQL secondary cannot keep up with the speed
    of the MySQL primary during the replay process.'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 总结上述测试结果：当 MySQL 主机达到 500,000 tpmC 的吞吐量时，启用性能模式的 MySQL 从机显示出明显的瓶颈。此外，MySQL 从机在回放过程中无法跟上
    MySQL 主机的速度。
- en: 'Now, with the Performance Schema disabled, conduct the same concurrency test.
    See the specific results in the figure below:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，禁用性能模式，进行相同的并发测试。具体结果见下图：
- en: '![](../Images/7011d904c2a4b9d3de3c533579f814c3.png)'
  id: totrans-131
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/7011d904c2a4b9d3de3c533579f814c3.png)'
- en: Figure 11-22\. The replay queue size in Group Replication does not increase
    after disabling the Performance Schema.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-22。禁用性能模式后，组复制中的回放队列大小不会增加。
- en: 'The figure indicates that the number of transactions awaiting replay did not
    increase significantly over time. The throughput results after MySQL primary completes
    execution are as follows:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 图表显示，等待回放的交易数量在时间上没有显著增加。MySQL 主机完成执行后的吞吐量结果如下：
- en: '![](../Images/4208feaaa6443284b38bb656499ebbc3.png)'
  id: totrans-134
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/4208feaaa6443284b38bb656499ebbc3.png)'
- en: When MySQL primary testing completes, the MySQL secondary also finishes replay
    nearly simultaneously. This indicates that in mainstream NUMA environments, Performance
    Schema is highly detrimental to MySQL secondary replay. The NUMA compatibility
    problems with Performance Schema remain unsolved and will be a focus for future
    optimization.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 当 MySQL 主机测试完成时，MySQL 从机也几乎同时完成回放。这表明在主流 NUMA 环境中，性能模式对 MySQL 从机回放有极大的负面影响。性能模式与
    NUMA 的兼容性问题尚未解决，并将成为未来优化的重点。
- en: 11.5.6 Effect of Doublewrite on Performance
  id: totrans-136
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.6 doublewrite 对性能的影响
- en: 'Here’s a brief introduction to the *innodb_doublewrite* parameter:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 这里简要介绍 *innodb_doublewrite* 参数：
- en: '![](../Images/53dc807f22f22fed43ef0996624eddb2.png)'
  id: totrans-138
  prefs: []
  type: TYPE_IMG
  zh: '![图片](../Images/53dc807f22f22fed43ef0996624eddb2.png)'
- en: The doublewrite buffer is a storage area where InnoDB writes pages from the
    buffer pool before committing them to the data files. This mechanism ensures data
    integrity during crash recovery by providing a reliable page copy in case of failures.
    However, since the default InnoDB page size is 16 KB while file systems can only
    guarantee atomicity up to 4 KB, only part of the page may be recoverable. Enabling
    doublewrite helps InnoDB recover the full page by writing it twice.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: doublewrite 缓冲区是一个存储区域，InnoDB 在将页面提交到数据文件之前，会从缓冲池中将页面写入该区域。这种机制通过在出现故障时提供可靠的页面副本，确保在崩溃恢复期间的数据完整性。然而，由于默认的
    InnoDB 页面大小为 16 KB，而文件系统只能保证最多 4 KB 的原子性，因此可能只有页面的一部分可以恢复。启用 doublewrite 有助于 InnoDB
    通过写入两次来恢复整个页面。
- en: The impact of enabling doublewrite on performance is assessed using the improved
    MySQL 8.0.27 with PGO. The figure below shows the effect of disabling doublewrite
    on TPC-C throughput across different concurrency levels.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 使用改进的 MySQL 8.0.27 版本和 PGO 评估启用 doublewrite 对性能的影响。下图显示了在不同并发级别上禁用 doublewrite
    对 TPC-C 吞吐量的影响。
- en: '![image-20240829115642934](../Images/0794264e1dc288cefcc970feadc743b2.png)'
  id: totrans-141
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115642934](../Images/0794264e1dc288cefcc970feadc743b2.png)'
- en: Figure 11-23\. Achieve higher peak throughput with doublewrite disabled.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-23。禁用 doublewrite 实现更高的峰值吞吐量。
- en: From the figure, it is evident that disabling the doublewrite parameter can
    increase peak throughput. While extensive testing and statistical analysis indicate
    that this parameter has a limited overall impact on performance, it does help
    to improve peak throughput. However, disabling doublewrite may compromise recovery
    safety in the event of a database crash, so it should be used with caution.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，禁用 doublewrite 参数可以提高峰值吞吐量。虽然广泛的测试和统计分析表明该参数对性能的整体影响有限，但它确实有助于提高峰值吞吐量。然而，禁用
    doublewrite 可能会在数据库崩溃事件中危及恢复安全性，因此应谨慎使用。
- en: 11.5.7 Effect of Binlog Row Image Format on Performance
  id: totrans-144
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.7 Binlog 行图像格式对性能的影响
- en: 'Here’s a brief introduction to the *binlog_row_image* parameter:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 下面是对 *binlog_row_image* 参数的简要介绍：
- en: '![](../Images/2f97131bbc241bbcfd152546ac133f52.png)'
  id: totrans-146
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/2f97131bbc241bbcfd152546ac133f52.png)'
- en: 'For MySQL row-based replication, this variable controls how row images are
    recorded in the binary log [13]. Each row change event consists of two images:
    a “before” image, which represents the row’s state before the change, and an “after”
    image, which reflects the updated state. Typically, MySQL logs all columns for
    both images. However, it is possible to log only the necessary columns, which
    can reduce disk, memory, and network usage.'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 对于 MySQL 基于行的复制，此变量控制行图像在二进制日志中的记录方式 [13]。每个行变更事件包含两个图像：一个“之前”图像，表示变更之前的行状态，以及一个“之后”图像，反映了更新后的状态。通常，MySQL
    为这两个图像记录所有列。然而，只记录必要的列是可能的，这可以减少磁盘、内存和网络的使用。
- en: 'Based on the improved version of MySQL 8.0.27 with PGO, the impact of the *binlog_row_image*
    parameter on TPC-C throughput at various concurrency levels is analyzed. See the
    figure below:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: 基于 MySQL 8.0.27 的改进版本和 PGO，分析了 *binlog_row_image* 参数在各个并发级别对 TPC-C 吞吐量的影响。请参考下面的图示：
- en: '![image-20240829115703081](../Images/56b6479dbd97992f5adfa2b8d1a20175.png)'
  id: totrans-149
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115703081](../Images/56b6479dbd97992f5adfa2b8d1a20175.png)'
- en: Figure 11-24\. Achieve improved throughput with minimal logging.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-24\. 通过最小化日志记录实现提高吞吐量。
- en: From the figure, it can be observed that using *binlog_row_image=minimal* provides
    a moderate improvement in throughput for the MySQL primary, but the increase is
    not substantial. Regarding MySQL secondary replay, specific details can be found
    in section 10.3.7.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以观察到，使用 *binlog_row_image=minimal* 对 MySQL 主节点的吞吐量提供了适度的提升，但增加并不显著。关于 MySQL
    从节点重放的具体细节可以在第 10.3.7 节中找到。
- en: 11.5.8 Understanding the Effect of Binlog Compression Settings on Performance
  id: totrans-152
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.8 理解 Binlog 压缩设置对性能的影响
- en: 'Here’s a brief introduction to the *binlog_transaction_compression* parameter:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 下面是对 *binlog_transaction_compression* 参数的简要介绍：
- en: '![](../Images/6e5b68ee03115af9625ec1368cdd8dd7.png)'
  id: totrans-154
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/6e5b68ee03115af9625ec1368cdd8dd7.png)'
- en: When binary log transaction compression is enabled, transaction payloads are
    compressed and written to the binary log as a single event. These compressed payloads
    remain compressed in the replication stream and relay logs, reducing storage requirements
    and saving network bandwidth for both the originator and recipients of the transactions
    [13].
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 当启用二进制日志事务压缩时，事务负载会被压缩并作为一个单独的事件写入二进制日志。这些压缩负载在复制流和重传日志中保持压缩状态，减少了存储需求并节省了事务发起者和接收者的网络带宽
    [13]。
- en: 'In a Group Replication cluster within the same data center, with *binlog_transaction_compression*
    enabled for MySQL primary and secondaries, let’s analyze the effect of binary
    log compression on TPC-C throughput. Refer to the figure below for detailed results:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 在同一数据中心内的 Group Replication 集群中，对于 MySQL 的主节点和从节点启用了 *binlog_transaction_compression*，让我们分析二进制日志压缩对
    TPC-C 吞吐量的影响。请参考下面的图示以获取详细结果：
- en: '![image-20240829115724267](../Images/c85358845f93c8b9a920bba9aac88a91.png)'
  id: totrans-157
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240829115724267](../Images/c85358845f93c8b9a920bba9aac88a91.png)'
- en: Figure 11-25\. Binlog compression may negatively impact performance in LAN environments.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 图 11-25\. 在 LAN 环境中，二进制日志压缩可能会对性能产生负面影响。
- en: From the figure, it is evident that enabling binlog compression results in a
    significant decrease in throughput for the Group Replication cluster, particularly
    under high concurrency. This decline occurs when the network benefits from compression
    are outweighed by the computational costs involved.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，启用二进制日志压缩会导致 Group Replication 集群的吞吐量显著下降，尤其是在高并发情况下。这种下降发生在网络从压缩中获得的收益被涉及的计算成本所抵消时。
- en: To investigate whether increasing network latency could improve throughput after
    compression, a simulated network latency of 10ms was used. The comparison of TPC-C
    throughput versus concurrency levels, before and after binlog compression, is
    shown in the following figure.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 为了调查增加网络延迟是否可以提高压缩后的吞吐量，使用了10ms的模拟网络延迟。以下图中显示了在binlog压缩前后，TPC-C吞吐量与并发级别的比较。
- en: '![image-20240901103231333](../Images/67872737f3eef310026eba4f69d2de20.png)'
  id: totrans-161
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240901103231333](../Images/67872737f3eef310026eba4f69d2de20.png)'
- en: Figure 11-26\. Binlog compression does not affect performance in WAN environments.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-26\. Binlog压缩不会影响WAN环境中的性能。
- en: From the figure, it is evident that with a 10ms network latency, the throughput
    after compression is similar to that before compression. This suggests that increased
    network latency can help alleviate the performance degradation associated with
    MySQL compression.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，在10ms的网络延迟下，压缩后的吞吐量与压缩前相似。这表明增加网络延迟可以帮助缓解与MySQL压缩相关的性能下降。
- en: Users should weigh the trade-off between storage cost reduction and performance
    improvement based on their specific needs.
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 用户应根据其具体需求权衡存储成本降低和性能提升之间的权衡。
- en: 11.5.9 Understanding the Effect of InnoDB Buffer Pool Size on Performance
  id: totrans-165
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 11.5.9 理解InnoDB缓冲池大小对性能的影响
- en: 'Here’s a brief introduction to the *innodb_buffer_pool_size* parameter:'
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: 这里简要介绍*innodb_buffer_pool_size*参数：
- en: '![](../Images/d2f280b0b3a24308facdfb1b3dc0ce7a.png)'
  id: totrans-167
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/d2f280b0b3a24308facdfb1b3dc0ce7a.png)'
- en: The larger buffer pool retains more data in memory, reducing page evictions,
    I/O operations, and contention within the buffer pool [13].
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 较大的缓冲池在内存中保留更多数据，减少页面淘汰、I/O操作和缓冲池内的竞争[13]。
- en: Based on the improved MySQL 8.0.27 version with PGO, the impact of the *innodb_buffer_pool_size*
    parameter on TPC-C throughput at various concurrency levels is analyzed. The results,
    with a warehouse count of 1000, are shown in the figure below.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 基于改进的MySQL 8.0.27版本和PGO，分析了*innodb_buffer_pool_size*参数在各个并发级别对TPC-C吞吐量的影响。结果（仓库数量为1000）显示在下图中。
- en: '![image-20240901104239714](../Images/f411e5be1fcf1261dd5a8bf88e01b6b7.png)'
  id: totrans-170
  prefs: []
  type: TYPE_IMG
  zh: '![image-20240901104239714](../Images/f411e5be1fcf1261dd5a8bf88e01b6b7.png)'
- en: 'Figure 11-27\. innodb_buffer_pool_size: optimal size is key to performance,
    not just larger.'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 图11-27\. innodb_buffer_pool_size：最佳大小是性能的关键，而不仅仅是更大。
- en: From the figure, it is evident that increasing the buffer pool size does not
    always lead to higher throughput. For 1000 warehouses, occupying around 92GB of
    I/O space in the test, setting *innodb_buffer_pool_size* to 92GB performs better
    than setting it to 192GB.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 从图中可以看出，增加缓冲池大小并不总是导致更高的吞吐量。对于测试中占用约92GB I/O空间的1000个仓库，将*innodb_buffer_pool_size*设置为92GB比设置为192GB表现更好。
- en: Notably, the *innodb_buffer_pool_size* parameter is well-suited for dynamic
    adaptive tuning using AI.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 显然，*innodb_buffer_pool_size*参数非常适合使用AI进行动态自适应调整。
- en: 11.6 Summary
  id: totrans-174
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 11.6 概述
- en: This chapter focuses on optimizing MySQL application performance without modifying
    MySQL source code. Key methods include using PGO, minimizing network interactions,
    employing advanced memory allocation tools, and improving indexing and parameter
    configurations.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 本章重点介绍在不修改MySQL源代码的情况下优化MySQL应用性能的方法。关键方法包括使用PGO、最小化网络交互、采用高级内存分配工具以及改进索引和参数配置。
- en: The effectiveness of these optimization methods varies depending on the MySQL
    version, configuration parameters, hardware environment, and specific application
    characteristics. While a parameter might significantly impact performance in one
    scenario, its effectiveness may decrease in another. This variability arises from
    the complex interactions between multiple performance-affecting queues and potential
    bottlenecks, making performance testing particularly challenging.
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 这些优化方法的有效性取决于MySQL版本、配置参数、硬件环境和特定应用特性。虽然一个参数可能在一种情况下对性能有显著影响，但在另一种情况下其有效性可能会降低。这种可变性源于多个影响性能的队列和潜在瓶颈之间的复杂交互，使得性能测试特别具有挑战性。
- en: '[Next](/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Part5.html)'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: '[下一页](/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/Part5.html)'
