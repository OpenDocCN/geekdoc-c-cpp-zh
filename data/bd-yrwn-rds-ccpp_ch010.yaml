- en: 09\. Data Serialization
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 09. 数据序列化
- en: For now, our server protocol response is an error code plus a string. What if
    we need to return more complicated data? For example, we might add the `keys`
    command that returns a list of strings. We have already encoded the list-of-strings
    data in the request protocol. In this chapter, we will generalize the encoding
    to handle different types of data. This is often called “serialization”.
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 目前，我们的服务器协议响应是一个错误代码加上一个字符串。如果我们需要返回更复杂的数据呢？例如，我们可能会添加返回字符串列表的 `keys` 命令。我们已经在请求协议中编码了字符串列表数据。在本章中，我们将泛化编码以处理不同类型的数据。这通常被称为“序列化”。
- en: 'Our serialization protocol consists of five types of data:'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 我们的序列化协议由五种数据类型组成：
- en: '[PRE0]'
  id: totrans-3
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: The `SER_NIL` is like `NULL`, the `SER_ERR` is for returning error code and
    message, the `SER_STR` and `SER_INT` are for string and `int64`, and the `SER_ARR`
    is for arrays.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: '`SER_NIL` 类似于 `NULL`，`SER_ERR` 用于返回错误代码和消息，`SER_STR` 和 `SER_INT` 用于字符串和 `int64`，而
    `SER_ARR` 用于数组。'
- en: 'Code listing starts with the `try_one_request` function:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 代码列表从 `try_one_request` 函数开始：
- en: '[PRE1]'
  id: totrans-6
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: For convenience, `std::string` was used to hold the response data. Production-grade
    projects often have more sophisticated ways to manage buffers.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 为了方便起见，使用了 `std::string` 来存储响应数据。生产级别的项目通常有更复杂的方式来管理缓冲区。
- en: 'A new command `keys` was added to the `do_request` handler:'
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 新增了一个名为 `keys` 的命令到 `do_request` 处理器中：
- en: '[PRE2]'
  id: totrans-9
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'The code for our serialization protocol:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 我们序列化协议的代码：
- en: '[PRE3]'
  id: totrans-11
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: As we can see, our serialization protocol starts with one byte of data type,
    followed by various types of payload data. Arrays come with their size first,
    then their possibly nested elements.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 如我们所见，我们的序列化协议以一个数据类型字节开始，随后是各种类型的有效负载数据。数组首先包含其大小，然后是其可能嵌套的元素。
- en: 'The `do_keys` function generates a response consisting of a list of strings:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: '`do_keys` 函数生成一个由字符串列表组成的响应：'
- en: '[PRE4]'
  id: totrans-14
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: The `del` command responds with an integer indicating whether the deletion took
    place.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '`del` 命令会返回一个整数，表示删除是否成功。'
- en: '[PRE5]'
  id: totrans-16
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The code for other commands is of nothing interesting, there is no need to list
    them.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 其他命令的代码没有什么有趣的地方，没有必要列出它们。
- en: 'Listing the client “deserialization” code:'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 列出客户端的“反序列化”代码：
- en: '[PRE6]'
  id: totrans-19
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Testing our new server/client:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 测试我们的新服务器/客户端：
- en: '[PRE7]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '[09_client.cpp](https://build-your-own.org/redis/09/09_client.cpp.htm)'
  id: totrans-22
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[09_client.cpp](https://build-your-own.org/redis/09/09_client.cpp.htm)'
- en: '[09_server.cpp](https://build-your-own.org/redis/09/09_server.cpp.htm)'
  id: totrans-23
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[09_server.cpp](https://build-your-own.org/redis/09/09_server.cpp.htm)'
- en: '[hashtable.cpp](https://build-your-own.org/redis/09/hashtable.cpp.htm)'
  id: totrans-24
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[hashtable.cpp](https://build-your-own.org/redis/09/hashtable.cpp.htm)'
- en: '[hashtable.h](https://build-your-own.org/redis/09/hashtable.h.htm)'
  id: totrans-25
  prefs:
  - PREF_BQ
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[hashtable.h](https://build-your-own.org/redis/09/hashtable.h.htm)'
